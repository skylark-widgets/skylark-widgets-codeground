/**
 * skylark-widgets-coder - The skylark code editor widget for showcasing html/css/js.
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-widgets/skylark-widgets-coder/
 * @license MIT
 */
!function(t,e){var n=e.define,s=e.require,r="function"==typeof n&&n.amd,i=!r&&"undefined"!=typeof exports;if(!r&&!n){var o={};n=e.define=function(t,e,n){"function"==typeof n?(o[t]={factory:n,deps:e.map(function(e){return function(t,e){if("."!==t[0])return t;var n=e.split("/"),s=t.split("/");n.pop();for(var r=0;r<s.length;r++)"."!=s[r]&&(".."==s[r]?n.pop():n.push(s[r]));return n.join("/")}(e,t)}),resolved:!1,exports:null},s(t)):o[t]={factory:null,resolved:!0,exports:n}},s=e.require=function(t){if(!o.hasOwnProperty(t))throw new Error("Module "+t+" has not been defined");var n=o[t];if(!n.resolved){var r=[];n.deps.forEach(function(t){r.push(s(t))}),n.exports=n.factory.apply(e,r)||null,n.resolved=!0}return n.exports}}if(!n)throw new Error("The module utility (ex: requirejs or skylark-utils) is not loaded!");if(function(t,e){t("skylark-widgets-coder/util",["skylark-net-http/Xhr"],function(t){"use strict";function e(t={},e={}){var n={};return Object.keys(t).forEach(function(e){n[e]=t[e]}),Object.keys(e).forEach(function(s){void 0!==n[s]?n[s]=t[s]:n[s]=e[s]}),n}function n(t,e,s,r,i){s[t](e,function(t,e,s,r,i){return function(e,o){e&&r.push(e),++t<s.length?n(t,o,s,r,i):i(r,o)}}.apply(this,arguments))}function s(t,e){if(!t.className)return!1;var n=" "+t.className+" ";return e=" "+e+" ",-1!==n.indexOf(e)}var r={html:"html",css:"css",js:"javascript",less:"less",styl:"stylus",coffee:"coffeescript"};return{extend:e,fetch:function(e,n){t.get(e).then(function(t){n(null,t)},function(t){n(t)})},seq:function(t,e,s=function(){}){var r=[];if(!t.length)return s(r,e);n(0,e,t,r,s)},debounce:function(t,e){var n=null,s=null;return function(){n?s=!0:t.apply(this,arguments),clearTimeout(n),n=setTimeout(()=>{s&&t.apply(this,arguments),n=null,s=null},e)}},log:function(){console.log(arguments)},getMode:function(t="",n="",s={}){var i=e(s,r);for(let t in i){let e=t.length;if(n.slice(-e++)==="."+t)return i[t]}for(let e in i)if(t===e)return i[e];return t},data:function(t,e){return t.getAttribute("data-"+e)},hasClass:s,addClass:function(t,e){if(s(t,e))return t.className;t.className&&(e=" "+e);return t.className+=e,t.className},removeClass:function(t,e){var n=" "+e,s=e+" ";-1!==t.className.indexOf(n)?t.className=t.className.replace(n,""):-1!==t.className.indexOf(s)?t.className=t.className.replace(s,""):t.className=t.className.replace(e,"");return t.className}}}),t("skylark-widgets-coder/template",[],function(){"use strict";return{container:function(){return'\n    <ul class="coder-nav">\n      <li class="coder-nav-item coder-nav-item-result">\n        <a href="#" data-coder-type="result">\n          Result\n        </a>\n      </li>\n      <li class="coder-nav-item coder-nav-item-html">\n        <a href="#" data-coder-type="html">\n          HTML\n        </a>\n      </li>\n      <li class="coder-nav-item coder-nav-item-css">\n        <a href="#" data-coder-type="css">\n          CSS\n        </a>\n      </li>\n      <li class="coder-nav-item coder-nav-item-js">\n        <a href="#" data-coder-type="js">\n          JavaScript\n        </a>\n      </li>\n    </ul>\n    <div class="coder-pane coder-pane-result"><iframe></iframe></div>\n    <div class="coder-pane coder-pane-html"></div>\n    <div class="coder-pane coder-pane-css"></div>\n    <div class="coder-pane coder-pane-js"></div>\n  '},paneActiveClass:function(t){return`coder-pane-active-${t}`},containerClass:function(){return"coder"},hasFileClass:function(t){return`coder-has-${t}`},editorClass:function(t){return`coder-editor coder-editor-${t}`},editorContent:function(t,e=""){return`\n    <textarea data-coder-type="${t}" data-coder-file="${e}"></textarea>\n    <div class="coder-status"></div>\n  `},statusMessage:function(t){return`\n    <p>${t}</p>\n  `},statusClass:function(t){return`coder-status-${t}`},statusActiveClass:function(t){return`coder-status-active-${t}`},pluginClass:function(t){return`coder-plugin-${t}`},statusLoading:function(t){return`Loading <strong>${t}</strong>..`},statusFetchError:function(t){return`There was an error loading <strong>${t}</strong>.`}}}),t("skylark-widgets-coder/plugin",["./util","./template"],function(t,e){"use strict";var n=[];return{register:function(t,e){e._id=t,n.push(e)},init:function(){this._get("options").plugins.forEach(s=>{let r,i,o={};"string"==typeof s?i=s:"object"==typeof s&&(i=s.name,o=s.options||{}),r=function(t){for(let e in n){let s=n[e];if(s._id===t)return s}throw new Error(`Plugin ${t} is not registered.`)}(i),this._get("plugins")[s]=new r(this,o),t.addClass(this._get("$container"),e.pluginClass(i))})}}}),t("skylark-widgets-coder/pubsoup",["./util"],function(t){"use strict";return class{constructor(){this.topics={},this.callbacks={}}find(t){return this.topics[t]=this.topics[t]||[],this.topics[t]}subscribe(t,e,n=90){var s=this.find(t);e._priority=n,s.push(e),s.sort(function(t,e){return t._priority>e._priority?1:e._priority>t._priority?-1:0})}remover(t,e){t.forEach(function(){if(e){var n=[].indexOf.call(t,e);-1!==n&&t.splice(n,1)}else t.length=0})}unsubscribe(t,e){var n=this.find(t);this.remover(n,e),this.callbacks[t]=this.callbacks[t]||[],this.remover(this.callbacks[t],e)}publish(e,n={}){var s=this.find(e),r=[];s.forEach(function(t){r.push(t)}),t.seq(r,n,this.runCallbacks(e))}runCallbacks(t){return(e,n)=>{this.callbacks[t]=this.callbacks[t]||[],this.callbacks[t].forEach(t=>{t(e,n)})}}done(t,e=function(){}){this.callbacks[t]=this.callbacks[t]||[],this.callbacks[t].push(e)}}}),t("skylark-widgets-coder/Coder",["skylark-langx/skylark","./util","./template","./plugin","./pubsoup"],function(t,e,n,s,r,i){"use strict";class o{constructor(t,i){if(!t)throw new Error("Can't find Coder container.");var o={};this._get=function(t){return o[t]},this._set=function(t,e){return o[t]=e,o[t]};var a=this._set("options",e.extend(i,{files:[],showBlank:!1,runScripts:!0,pane:"result",debounce:250,plugins:[]}));a.plugins.push("render"),!1===a.runScripts&&a.plugins.push("scriptless"),this._set("cachedContent",{html:null,css:null,js:null});var c=this._set("pubsoup",new r);this._set("trigger",this.trigger()),this._set("on",function(){c.subscribe.apply(c,arguments)}),this._set("off",function(){c.unsubscribe.apply(c,arguments)});var l=this._set("done",function(){c.done.apply(c,arguments)});l("change",this.errors.bind(this));var d=this._set("$container",t);d.innerHTML=n.container(),e.addClass(d,n.containerClass());var u=this._set("paneActive",a.pane);e.addClass(d,n.paneActiveClass(u)),this._set("$status",{});for(let t of["html","css","js"])this.markup(t);d.addEventListener("keyup",e.debounce(this.change.bind(this),a.debounce)),d.addEventListener("change",e.debounce(this.change.bind(this),a.debounce)),d.addEventListener("click",this.pane.bind(this)),this.$container=this._get("$container"),this.on=this._get("on"),this.off=this._get("off"),this.done=this._get("done"),this.trigger=this._get("trigger"),this.paneActive=this._get("paneActive"),this._set("plugins",{}),s.init.call(this);for(let t of["html","css","js"])this.load(t);if(a.showBlank)for(let t of["html","css","js"])e.addClass(d,n.hasFileClass(t))}findFile(t){var e=this._get("options");for(let n in e.files){let s=e.files[n];if(s.type===t)return s}return{}}markup(t){var s=this._get("$container"),r=s.querySelector(`.coder-pane-${t}`),i=this.findFile(t),o=document.createElement("div");o.innerHTML=n.editorContent(t,i.url),o.className=n.editorClass(t),r.appendChild(o),this._get("$status")[t]=r.querySelector(".coder-status"),void 0===i.url&&void 0===i.content||e.addClass(s,n.hasFileClass(t))}load(t){var s=this.findFile(t),r=this._get("$container").querySelector(`.coder-pane-${t} textarea`);void 0!==s.content?this.setValue(r,s.content):void 0!==s.url?(this.status("loading",[n.statusLoading(s.url)],{type:t,file:s}),e.fetch(s.url,(e,s)=>{e?this.status("error",[n.statusFetchError(e)],{type:t}):(this.clearStatus("loading",{type:t}),this.setValue(r,s))})):this.setValue(r,"")}setValue(t,e){t.value=e,this.change({target:t})}change(t){var n=e.data(t.target,"coder-type");if(n){var s=this._get("cachedContent");s[n]!==t.target.value&&(s[n]=t.target.value,this.trigger("change",{type:n,file:e.data(t.target,"coder-file"),content:s[n]}))}}errors(t,e){this.status("error",t,e)}pane(t){if(e.data(t.target,"coder-type")){var s=this._get("$container"),r=this._get("paneActive");e.removeClass(s,n.paneActiveClass(r)),r=this._set("paneActive",e.data(t.target,"coder-type")),e.addClass(s,n.paneActiveClass(r)),t.preventDefault()}}status(t="error",s=[],r={}){if(!s.length)return this.clearStatus(t,r);var i=this._get("$status");e.addClass(i[r.type],n.statusClass(t)),e.addClass(this._get("$container"),n.statusActiveClass(r.type));var o="";s.forEach(function(t){o+=n.statusMessage(t)}),i[r.type].innerHTML=o}clearStatus(t,s){var r=this._get("$status");e.removeClass(r[s.type],n.statusClass(t)),e.removeClass(this._get("$container"),n.statusActiveClass(s.type)),r[s.type].innerHTML=""}trigger(){var t=this._get("options"),e=this._get("pubsoup");if(!1===t.debounce)return function(){e.publish.apply(e,arguments)};var n={},s={};return function(r,{type:i="default"}={}){n[i]?s[i]=!0:e.publish.apply(e,arguments),clearTimeout(n[i]),n[i]=setTimeout(()=>{s[i]&&e.publish.apply(e,arguments),s[i]=null,n[i]=null},t.debounce)}}}return o.plugin=function(){return s.register.apply(this,arguments)},t.attach("widgets.Coder",o)}),t("skylark-widgets-coder/addons/codemirror",["skylark-codemirror/CodeMirror","../util","../Coder"],function(t,e,n){"use strict";class s{constructor(n,s){var r;this.editor={},this.coder=n;var i={html:"htmlmixed"};s=e.extend(s,{lineNumbers:!0});var o=n.$container.querySelectorAll(".coder-editor");for(r=0;r<o.length;r++){let n=o[r].querySelector("textarea"),a=e.data(n,"coder-type"),c=e.data(n,"coder-file");this.editor[a]=t.fromTextArea(n,s),this.editor[a].setOption("mode",e.getMode(a,c,i))}n.on("change",this.change.bind(this),1)}editorChange(t){return()=>{this.coder.trigger("change",t)}}change(t,e){var n=this.editor[t.type];t.cmEditor||(n.setValue(t.content),t.cmEditor=n,n.on("change",this.editorChange(t))),t.content=n.getValue(),e(null,t)}}return n.plugin("codemirror",s),s}),t("skylark-widgets-coder/addons/console",["../util","../Coder"],function(t,e){"use strict";class n{constructor(e,n){n=t.extend(n,{autoClear:!1});var s=`(function ${this.capture.toString()})();`,r=document.createElement("li");t.addClass(r,"coder-nav-item coder-nav-item-console"),r.innerHTML='<a href="#" data-coder-type="console">JS Console</a>';var i=document.createElement("div");t.addClass(i,"coder-pane coder-pane-console"),i.innerHTML='\n              <div class="coder-console-container">\n                <ul class="coder-console-output"></ul>\n                <form class="coder-console-input">\n                  <input type="text">\n                </form>\n              </div>\n              <button class="coder-button coder-console-clear">Clear</button>\n            ',e.$container.appendChild(i),e.$container.querySelector(".coder-nav").appendChild(r);var o=e.$container.querySelector(".coder-console-container"),a=e.$container.querySelector(".coder-console-output"),c=e.$container.querySelector(".coder-console-input input"),l=e.$container.querySelector(".coder-console-input"),d=e.$container.querySelector(".coder-console-clear");l.addEventListener("submit",this.submit.bind(this)),c.addEventListener("keydown",this.history.bind(this)),d.addEventListener("click",this.clear.bind(this)),!0===n.autoClear&&e.on("change",this.autoClear.bind(this),29),e.on("change",this.change.bind(this),30),window.addEventListener("message",this.getMessage.bind(this)),this.$coderContainer=e.$container,this.$container=o,this.$input=c,this.$output=a,this.history=[],this.historyIndex=0,this.logCaptureSnippet=s,this.contentCache={html:"",css:"",js:""},this.getIframe=this.getIframe.bind(this)}getIframe(){return this.$coderContainer.querySelector(".coder-pane-result iframe")}getMessage(t){if(t.source===this.getIframe().contentWindow){var e={};try{e=JSON.parse(t.data)}catch(t){}"coder-console-log"===e.type&&this.log(e.message)}}autoClear(t,e){var n=t.content;"js"===t.type&&(n=n.replace(this.logCaptureSnippet,"")),!0!==t.forceRender&&this.contentCache[t.type]===n||this.clear(),this.contentCache[t.type]=n,e(null,t)}change(t,e){if("js"!==t.type)return e(null,t);-1===t.content.indexOf(this.logCaptureSnippet)&&(t.content=`${this.logCaptureSnippet}${t.content}`),e(null,t)}capture(){void 0!==window.console&&void 0!==window.console.log||(window.console={log:function(){}});var t=Function.prototype.bind.call(window.console.log,window.console);window.console.log=function(){[].slice.call(arguments).forEach(function(t){window.parent.postMessage(JSON.stringify({type:"coder-console-log",message:t}),"*")}),t.apply(t,arguments)}}log(e="",n){var s=document.createElement("li");t.addClass(s,"coder-console-log"),void 0!==n&&t.addClass(s,`coder-console-log-${n}`),s.innerHTML=e,this.$output.appendChild(s)}submit(t){var e=this.$input.value.trim();if(""===e)return t.preventDefault();this.history.push(e),this.historyIndex=this.history.length,this.log(e,"history"),0!==e.indexOf("return")&&(e="return "+e);try{var n=this.getIframe().contentWindow.eval(`(function() {${e}})()`);this.log(n)}catch(t){this.log(t,"error")}this.$input.value="",this.$container.scrollTop=this.$container.scrollHeight,t.preventDefault()}clear(){this.$output.innerHTML=""}history(t){var e=!1,n=this.$input.selectionStart;38===t.keyCode&&0!==this.historyIndex&&0===n&&(this.historyIndex--,e=!0),40===t.keyCode&&this.historyIndex!==this.history.length-1&&n===this.$input.value.length&&(this.historyIndex++,e=!0),e&&(this.$input.value=this.history[this.historyIndex])}}return e.plugin("console",n),n}),t("skylark-widgets-coder/addons/play",["../util","../Coder"],function(t,e){"use strict";class n{constructor(e,n){var s={};!1===(n=t.extend(n,{firstRun:!0})).firstRun&&(s={html:{type:"html",content:""},css:{type:"css",content:""},js:{type:"js",content:""}});var r=document.createElement("button");r.className="coder-button coder-button-play",r.innerHTML="Run",e.$container.appendChild(r),r.addEventListener("click",this.run.bind(this)),e.on("change",this.change.bind(this),10),this.cache=s,this.code={},this.coder=e}change(e,n){this.code[e.type]=t.extend(e),void 0!==this.cache[e.type]?(n(null,this.cache[e.type]),this.cache[e.type].forceRender=null):(this.cache[e.type]=t.extend(e),n(null,e))}run(){for(let e in this.code)this.cache[e]=t.extend(this.code[e],{forceRender:!0}),this.coder.trigger("change",this.cache[e])}}return e.plugin("play",n),n}),t("skylark-widgets-coder/addons/render",["../util","../Coder"],function(t,e){"use strict";class n{constructor(e,n){n=t.extend(n,{});var s=!!("srcdoc"in document.createElement("iframe")),r=e.$container.querySelector(".coder-pane-result iframe");window.addEventListener("message",this.domready.bind(this)),e.on("change",this.change.bind(this),100),this.supportSrcdoc=s,this.content={html:"",css:"",js:""},this.frameContent="",this.$resultFrame=r,this.callbacks=[],this.index=0,this.lastCallback=(()=>{})}template(t="",e="",n=""){return`\n      <!doctype html>\n      <html>\n        <head>\n          <script>\n            (function () {\n              window.addEventListener('DOMContentLoaded', function () {\n                window.parent.postMessage(JSON.stringify({\n                  type: 'coder-dom-ready'\n                }), '*')\n              })\n            }())\n          <\/script>\n\n          <style>${t}</style>\n        </head>\n        <body>\n          ${e}\n\n          \x3c!--\n            Coder:\n            Empty script tag prevents malformed HTML from breaking the next script.\n          --\x3e\n          <script><\/script>\n          <script>${n}<\/script>\n        </body>\n      </html>\n    `}change(t,e){this.content[t.type]=t.content;var n=this.frameContent;if(this.frameContent=this.template(this.content.css,this.content.html,this.content.js),this.lastCallback=(()=>{this.lastCallback=(()=>{}),e(null,t)}),!0===t.forceRender||this.frameContent!==n)if(this.supportSrcdoc){var s=document.createElement("iframe");this.$resultFrame.parentNode.replaceChild(s,this.$resultFrame),this.$resultFrame=s,this.$resultFrame.contentWindow.document.open(),this.$resultFrame.contentWindow.document.write(this.frameContent),this.$resultFrame.contentWindow.document.close()}else{this.$resultFrame.setAttribute("data-srcdoc",this.frameContent);var r='javascript:window.frameElement.getAttribute("data-srcdoc");';this.$resultFrame.setAttribute("src",r),this.$resultFrame.contentWindow&&(this.$resultFrame.contentWindow.location=r)}else e(null,t)}domready(t){if(t.source===this.$resultFrame.contentWindow){var e={};try{e=JSON.parse(t.data)}catch(t){}"coder-dom-ready"===e.type&&this.lastCallback()}}}return e.plugin("render",n),n}),t("skylark-widgets-coder/main",["./Coder","./addons/codemirror","./addons/console","./addons/play","./addons/render"],function(t){return t}),t("skylark-widgets-coder",["skylark-widgets-coder/main"],function(t){return t})}(n),!r){var a=s("skylark-langx/skylark");i?module.exports=a:e.skylarkjs=a}}(0,this);
//# sourceMappingURL=sourcemaps/skylark-widgets-coder.js.map
