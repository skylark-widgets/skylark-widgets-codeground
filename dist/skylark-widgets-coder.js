/**
 * skylark-widgets-coder - The skylark code editor widget for showcasing html/css/js.
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-widgets/skylark-widgets-coder/
 * @license MIT
 */
!function(t,e){var n=e.define,s=e.require,r="function"==typeof n&&n.amd,i=!r&&"undefined"!=typeof exports;if(!r&&!n){var o={};n=e.define=function(t,e,n){"function"==typeof n?(o[t]={factory:n,deps:e.map(function(e){return function(t,e){if("."!==t[0])return t;var n=e.split("/"),s=t.split("/");n.pop();for(var r=0;r<s.length;r++)"."!=s[r]&&(".."==s[r]?n.pop():n.push(s[r]));return n.join("/")}(e,t)}),resolved:!1,exports:null},s(t)):o[t]={factory:null,resolved:!0,exports:n}},s=e.require=function(t){if(!o.hasOwnProperty(t))throw new Error("Module "+t+" has not been defined");var n=o[t];if(!n.resolved){var r=[];n.deps.forEach(function(t){r.push(s(t))}),n.exports=n.factory.apply(e,r)||null,n.resolved=!0}return n.exports}}if(!n)throw new Error("The module utility (ex: requirejs or skylark-utils) is not loaded!");if(function(t,e){t("skylark-widgets-coder/util",["skylark-langx/langx","skylark-net-http/Xhr"],function(t,e){"use strict";function n(t,e,s,r,i){s[t](e,function(t,e,s,r,i){return function(e,o){e&&r.push(e),++t<s.length?n(t,o,s,r,i):i(r,o)}}.apply(this,arguments))}var s={html:"html",css:"css",js:"javascript",less:"less",styl:"stylus",coffee:"coffeescript"};return{fetch:function(t,n){e.get(t).then(function(t){n(null,t)},function(t){n(t)})},seq:function(t,e,s=function(){}){var r=[];if(!t.length)return s(r,e);n(0,e,t,r,s)},log:function(){console.log(arguments)},getMode:function(e="",n="",r={}){var i=t.mixin({},s,r);for(let t in i){let e=t.length;if(n.slice(-e++)==="."+t)return i[t]}for(let t in i)if(e===t)return i[t];return e}}}),t("skylark-widgets-coder/template",[],function(){"use strict";return{container:function(){return'\n    <ul class="coder-nav">\n      <li class="coder-nav-item coder-nav-item-result">\n        <a href="#" data-coder-type="result">\n          Result\n        </a>\n      </li>\n      <li class="coder-nav-item coder-nav-item-html">\n        <a href="#" data-coder-type="html">\n          HTML\n        </a>\n      </li>\n      <li class="coder-nav-item coder-nav-item-css">\n        <a href="#" data-coder-type="css">\n          CSS\n        </a>\n      </li>\n      <li class="coder-nav-item coder-nav-item-js">\n        <a href="#" data-coder-type="js">\n          JavaScript\n        </a>\n      </li>\n    </ul>\n    <div class="coder-pane coder-pane-result"><iframe></iframe></div>\n    <div class="coder-pane coder-pane-html"></div>\n    <div class="coder-pane coder-pane-css"></div>\n    <div class="coder-pane coder-pane-js"></div>\n  '},paneActiveClass:function(t){return`coder-pane-active-${t}`},containerClass:function(){return"coder"},hasFileClass:function(t){return`coder-has-${t}`},editorClass:function(t){return`coder-editor coder-editor-${t}`},editorContent:function(t,e=""){return`\n    <textarea data-coder-type="${t}" data-coder-file="${e}"></textarea>\n    <div class="coder-status"></div>\n  `},statusMessage:function(t){return`\n    <p>${t}</p>\n  `},statusClass:function(t){return`coder-status-${t}`},statusActiveClass:function(t){return`coder-status-active-${t}`},pluginClass:function(t){return`coder-plugin-${t}`},statusLoading:function(t){return`Loading <strong>${t}</strong>..`},statusFetchError:function(t){return`There was an error loading <strong>${t}</strong>.`}}}),t("skylark-widgets-coder/plugin",["skylark-domx-styler","./util","./template"],function(t,e,n){"use strict";var s=[];return{register:function(t,e){e._id=t,s.push(e)},init:function(){this._get("options").plugins.forEach(e=>{let r,i,o={};"string"==typeof e?i=e:"object"==typeof e&&(i=e.name,o=e.options||{}),r=function(t){for(let e in s){let n=s[e];if(n._id===t)return n}throw new Error(`Plugin ${t} is not registered.`)}(i),this._get("plugins")[e]=new r(this,o),t.addClass(this._get("$container"),n.pluginClass(i))})}}}),t("skylark-widgets-coder/pubsoup",["./util"],function(t){"use strict";return class{constructor(){this.topics={},this.callbacks={}}find(t){return this.topics[t]=this.topics[t]||[],this.topics[t]}subscribe(t,e,n=90){var s=this.find(t);e._priority=n,s.push(e),s.sort(function(t,e){return t._priority>e._priority?1:e._priority>t._priority?-1:0})}remover(t,e){t.forEach(function(){if(e){var n=[].indexOf.call(t,e);-1!==n&&t.splice(n,1)}else t.length=0})}unsubscribe(t,e){var n=this.find(t);this.remover(n,e),this.callbacks[t]=this.callbacks[t]||[],this.remover(this.callbacks[t],e)}publish(e,n={}){var s=this.find(e),r=[];s.forEach(function(t){r.push(t)}),t.seq(r,n,this.runCallbacks(e))}runCallbacks(t){return(e,n)=>{this.callbacks[t]=this.callbacks[t]||[],this.callbacks[t].forEach(t=>{t(e,n)})}}done(t,e=function(){}){this.callbacks[t]=this.callbacks[t]||[],this.callbacks[t].push(e)}}}),t("skylark-widgets-coder/Coder",["skylark-langx/skylark","skylark-langx/langx","skylark-widgets-base/Widget","skylark-domx-styler","skylark-domx-data","./util","./template","./plugin","./pubsoup"],function(t,e,n,s,r,i,o,a,c,l){"use strict";class d extends n{get klassName(){return"Coder"}get pluginName(){return"lark.coder"}constructor(t,n){if(super(t,n),!t)throw new Error("Can't find Coder container.");var r={};this._get=function(t){return r[t]},this._set=function(t,e){return r[t]=e,r[t]};var i=this._set("options",e.extend({files:[],showBlank:!1,runScripts:!0,pane:"result",debounce:250,plugins:[]},n));i.plugins.push("render"),!1===i.runScripts&&i.plugins.push("scriptless"),this._set("cachedContent",{html:null,css:null,js:null});var l=this._set("pubsoup",new c);this._set("trigger",this.trigger()),this._set("on",function(){l.subscribe.apply(l,arguments)}),this._set("off",function(){l.unsubscribe.apply(l,arguments)});var d=this._set("done",function(){l.done.apply(l,arguments)});d("change",this.errors.bind(this));var u=this._set("$container",t);u.innerHTML=o.container(),s.addClass(u,o.containerClass());var h=this._set("paneActive",i.pane);s.addClass(u,o.paneActiveClass(h)),this._set("$status",{});for(let t of["html","css","js"])this.markup(t);u.addEventListener("keyup",e.debounce(this.change.bind(this),i.debounce)),u.addEventListener("change",e.debounce(this.change.bind(this),i.debounce)),u.addEventListener("click",this.pane.bind(this)),this.$container=this._get("$container"),this.on=this._get("on"),this.off=this._get("off"),this.done=this._get("done"),this.trigger=this._get("trigger"),this.paneActive=this._get("paneActive"),this._set("plugins",{}),a.init.call(this);for(let t of["html","css","js"])this.load(t);if(i.showBlank)for(let t of["html","css","js"])s.addClass(u,o.hasFileClass(t))}findFile(t){var e=this._get("options");for(let n in e.files){let s=e.files[n];if(s.type===t)return s}return{}}markup(t){var e=this._get("$container"),n=e.querySelector(`.coder-pane-${t}`),r=this.findFile(t),i=document.createElement("div");i.innerHTML=o.editorContent(t,r.url),i.className=o.editorClass(t),n.appendChild(i),this._get("$status")[t]=n.querySelector(".coder-status"),void 0===r.url&&void 0===r.content||s.addClass(e,o.hasFileClass(t))}load(t){var e=this.findFile(t),n=this._get("$container").querySelector(`.coder-pane-${t} textarea`);void 0!==e.content?this.setValue(n,e.content):void 0!==e.url?(this.status("loading",[o.statusLoading(e.url)],{type:t,file:e}),i.fetch(e.url,(e,s)=>{e?this.status("error",[o.statusFetchError(e)],{type:t}):(this.clearStatus("loading",{type:t}),this.setValue(n,s))})):this.setValue(n,"")}setValue(t,e){t.value=e,this.change({target:t})}change(t){var e=r.data(t.target,"coder-type");if(e){var n=this._get("cachedContent");n[e]!==t.target.value&&(n[e]=t.target.value,this.trigger("change",{type:e,file:r.data(t.target,"coder-file"),content:n[e]}))}}errors(t,e){this.status("error",t,e)}pane(t){if(r.data(t.target,"coder-type")){var e=this._get("$container"),n=this._get("paneActive");s.removeClass(e,o.paneActiveClass(n)),n=this._set("paneActive",r.data(t.target,"coder-type")),s.addClass(e,o.paneActiveClass(n)),t.preventDefault()}}status(t="error",e=[],n={}){if(!e.length)return this.clearStatus(t,n);var r=this._get("$status");s.addClass(r[n.type],o.statusClass(t)),s.addClass(this._get("$container"),o.statusActiveClass(n.type));var i="";e.forEach(function(t){i+=o.statusMessage(t)}),r[n.type].innerHTML=i}clearStatus(t,e){var n=this._get("$status");s.removeClass(n[e.type],o.statusClass(t)),s.removeClass(this._get("$container"),o.statusActiveClass(e.type)),n[e.type].innerHTML=""}trigger(){var t=this._get("options"),e=this._get("pubsoup");if(!1===t.debounce)return function(){e.publish.apply(e,arguments)};var n={},s={};return function(r,{type:i="default"}={}){n[i]?s[i]=!0:e.publish.apply(e,arguments),clearTimeout(n[i]),n[i]=setTimeout(()=>{s[i]&&e.publish.apply(e,arguments),s[i]=null,n[i]=null},t.debounce)}}}return d.plugin=function(){return a.register.apply(this,arguments)},t.attach("widgets.Coder",d)}),t("skylark-widgets-coder/addons/codemirror",["skylark-langx/langx","skylark-domx-data","skylark-codemirror/CodeMirror","../util","../Coder"],function(t,e,n,s,r){"use strict";class i{constructor(r,i){var o;this.editor={},this.coder=r;var a={html:"htmlmixed"};i=t.extend({},i,{lineNumbers:!0});var c=r.$container.querySelectorAll(".coder-editor");for(o=0;o<c.length;o++){let t=c[o].querySelector("textarea"),r=e.data(t,"coder-type"),l=e.data(t,"coder-file");this.editor[r]=n.fromTextArea(t,i),this.editor[r].setOption("mode",s.getMode(r,l,a))}r.on("change",this.change.bind(this),1)}editorChange(t){return()=>{this.coder.trigger("change",t)}}change(t,e){var n=this.editor[t.type];t.cmEditor||(n.setValue(t.content),t.cmEditor=n,n.on("change",this.editorChange(t))),t.content=n.getValue(),e(null,t)}}return r.plugin("codemirror",i),i}),t("skylark-widgets-coder/addons/console",["skylark-langx/langx","skylark-domx-styler","../util","../Coder"],function(t,e,n,s){"use strict";class r{constructor(n,s){s=t.mixin({autoClear:!1},s);var r=`(function ${this.capture.toString()})();`,i=document.createElement("li");e.addClass(i,"coder-nav-item coder-nav-item-console"),i.innerHTML='<a href="#" data-coder-type="console">JS Console</a>';var o=document.createElement("div");e.addClass(o,"coder-pane coder-pane-console"),o.innerHTML='\n              <div class="coder-console-container">\n                <ul class="coder-console-output"></ul>\n                <form class="coder-console-input">\n                  <input type="text">\n                </form>\n              </div>\n              <button class="coder-button coder-console-clear">Clear</button>\n            ',n.$container.appendChild(o),n.$container.querySelector(".coder-nav").appendChild(i);var a=n.$container.querySelector(".coder-console-container"),c=n.$container.querySelector(".coder-console-output"),l=n.$container.querySelector(".coder-console-input input"),d=n.$container.querySelector(".coder-console-input"),u=n.$container.querySelector(".coder-console-clear");d.addEventListener("submit",this.submit.bind(this)),l.addEventListener("keydown",this.history.bind(this)),u.addEventListener("click",this.clear.bind(this)),!0===s.autoClear&&n.on("change",this.autoClear.bind(this),29),n.on("change",this.change.bind(this),30),window.addEventListener("message",this.getMessage.bind(this)),this.$coderContainer=n.$container,this.$container=a,this.$input=l,this.$output=c,this.history=[],this.historyIndex=0,this.logCaptureSnippet=r,this.contentCache={html:"",css:"",js:""},this.getIframe=this.getIframe.bind(this)}getIframe(){return this.$coderContainer.querySelector(".coder-pane-result iframe")}getMessage(t){if(t.source===this.getIframe().contentWindow){var e={};try{e=JSON.parse(t.data)}catch(t){}"coder-console-log"===e.type&&this.log(e.message)}}autoClear(t,e){var n=t.content;"js"===t.type&&(n=n.replace(this.logCaptureSnippet,"")),!0!==t.forceRender&&this.contentCache[t.type]===n||this.clear(),this.contentCache[t.type]=n,e(null,t)}change(t,e){if("js"!==t.type)return e(null,t);-1===t.content.indexOf(this.logCaptureSnippet)&&(t.content=`${this.logCaptureSnippet}${t.content}`),e(null,t)}capture(){void 0!==window.console&&void 0!==window.console.log||(window.console={log:function(){}});var t=Function.prototype.bind.call(window.console.log,window.console);window.console.log=function(){[].slice.call(arguments).forEach(function(t){window.parent.postMessage(JSON.stringify({type:"coder-console-log",message:t}),"*")}),t.apply(t,arguments)}}log(t="",n){var s=document.createElement("li");e.addClass(s,"coder-console-log"),void 0!==n&&e.addClass(s,`coder-console-log-${n}`),s.innerHTML=t,this.$output.appendChild(s)}submit(t){var e=this.$input.value.trim();if(""===e)return t.preventDefault();this.history.push(e),this.historyIndex=this.history.length,this.log(e,"history"),0!==e.indexOf("return")&&(e="return "+e);try{var n=this.getIframe().contentWindow.eval(`(function() {${e}})()`);this.log(n)}catch(t){this.log(t,"error")}this.$input.value="",this.$container.scrollTop=this.$container.scrollHeight,t.preventDefault()}clear(){this.$output.innerHTML=""}history(t){var e=!1,n=this.$input.selectionStart;38===t.keyCode&&0!==this.historyIndex&&0===n&&(this.historyIndex--,e=!0),40===t.keyCode&&this.historyIndex!==this.history.length-1&&n===this.$input.value.length&&(this.historyIndex++,e=!0),e&&(this.$input.value=this.history[this.historyIndex])}}return s.plugin("console",r),r}),t("skylark-widgets-coder/addons/play",["skylark-langx/langx","../util","../Coder"],function(t,e,n){"use strict";class s{constructor(e,n){var s={};!1===(n=t.mixin({firstRun:!0},n)).firstRun&&(s={html:{type:"html",content:""},css:{type:"css",content:""},js:{type:"js",content:""}});var r=document.createElement("button");r.className="coder-button coder-button-play",r.innerHTML="Run",e.$container.appendChild(r),r.addEventListener("click",this.run.bind(this)),e.on("change",this.change.bind(this),10),this.cache=s,this.code={},this.coder=e}change(e,n){this.code[e.type]=t.clone(e),void 0!==this.cache[e.type]?(n(null,this.cache[e.type]),this.cache[e.type].forceRender=null):(this.cache[e.type]=t.clone(e),n(null,e))}run(){for(let e in this.code)this.cache[e]=t.mixin({forceRender:!0},this.code[e]),this.coder.trigger("change",this.cache[e])}}return n.plugin("play",s),s}),t("skylark-widgets-coder/addons/render",["skylark-langx/langx","../util","../Coder"],function(t,e,n){"use strict";class s{constructor(e,n){n=t.clone(n);var s=!!("srcdoc"in document.createElement("iframe")),r=e.$container.querySelector(".coder-pane-result iframe");window.addEventListener("message",this.domready.bind(this)),e.on("change",this.change.bind(this),100),this.supportSrcdoc=s,this.content={html:"",css:"",js:""},this.frameContent="",this.$resultFrame=r,this.callbacks=[],this.index=0,this.lastCallback=(()=>{})}template(t="",e="",n=""){return`\n      <!doctype html>\n      <html>\n        <head>\n          <script>\n            (function () {\n              window.addEventListener('DOMContentLoaded', function () {\n                window.parent.postMessage(JSON.stringify({\n                  type: 'coder-dom-ready'\n                }), '*')\n              })\n            }())\n          <\/script>\n\n          <style>${t}</style>\n        </head>\n        <body>\n          ${e}\n\n          \x3c!--\n            Coder:\n            Empty script tag prevents malformed HTML from breaking the next script.\n          --\x3e\n          <script><\/script>\n          <script>${n}<\/script>\n        </body>\n      </html>\n    `}change(t,e){this.content[t.type]=t.content;var n=this.frameContent;if(this.frameContent=this.template(this.content.css,this.content.html,this.content.js),this.lastCallback=(()=>{this.lastCallback=(()=>{}),e(null,t)}),!0===t.forceRender||this.frameContent!==n)if(this.supportSrcdoc){var s=document.createElement("iframe");this.$resultFrame.parentNode.replaceChild(s,this.$resultFrame),this.$resultFrame=s,this.$resultFrame.contentWindow.document.open(),this.$resultFrame.contentWindow.document.write(this.frameContent),this.$resultFrame.contentWindow.document.close()}else{this.$resultFrame.setAttribute("data-srcdoc",this.frameContent);var r='javascript:window.frameElement.getAttribute("data-srcdoc");';this.$resultFrame.setAttribute("src",r),this.$resultFrame.contentWindow&&(this.$resultFrame.contentWindow.location=r)}else e(null,t)}domready(t){if(t.source===this.$resultFrame.contentWindow){var e={};try{e=JSON.parse(t.data)}catch(t){}"coder-dom-ready"===e.type&&this.lastCallback()}}}return n.plugin("render",s),s}),t("skylark-widgets-coder/main",["./Coder","./addons/codemirror","./addons/console","./addons/play","./addons/render"],function(t){return t}),t("skylark-widgets-coder",["skylark-widgets-coder/main"],function(t){return t})}(n),!r){var a=s("skylark-langx/skylark");i?module.exports=a:e.skylarkjs=a}}(0,this);
//# sourceMappingURL=sourcemaps/skylark-widgets-coder.js.map
