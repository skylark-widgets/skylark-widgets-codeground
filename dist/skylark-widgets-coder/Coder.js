/**
 * skylark-widgets-coder - The skylark code editor widget for showcasing html/css/js.
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-widgets/skylark-widgets-coder/
 * @license MIT
 */
define(["skylark-langx/skylark","skylark-langx/langx","skylark-widgets-base/Widget","skylark-domx-styler","skylark-domx-data","./util","./template","./plugin","./pubsoup"],function(t,e,s,a,i,n,r,l,o,u){"use strict";class h extends s{get klassName(){return"Coder"}get pluginName(){return"lark.coder"}constructor(t,s){if(super(t,s),!t)throw new Error("Can't find Coder container.");var i={};this._get=function(t){return i[t]},this._set=function(t,e){return i[t]=e,i[t]};var n=this._set("options",e.extend({files:[],showBlank:!1,runScripts:!0,pane:"result",debounce:250,plugins:[]},s));n.plugins.push("render"),!1===n.runScripts&&n.plugins.push("scriptless"),this._set("cachedContent",{html:null,css:null,js:null});var u=this._set("pubsoup",new o);this._set("trigger",this.trigger()),this._set("on",function(){u.subscribe.apply(u,arguments)}),this._set("off",function(){u.unsubscribe.apply(u,arguments)}),this._set("done",function(){u.done.apply(u,arguments)})("change",this.errors.bind(this));var h=this._set("$container",t);h.innerHTML=r.container(),a.addClass(h,r.containerClass());var c=this._set("paneActive",n.pane);a.addClass(h,r.paneActiveClass(c)),this._set("$status",{});for(let t of["html","css","js"])this.markup(t);h.addEventListener("keyup",e.debounce(this.change.bind(this),n.debounce)),h.addEventListener("change",e.debounce(this.change.bind(this),n.debounce)),h.addEventListener("click",this.pane.bind(this)),this.$container=this._get("$container"),this.on=this._get("on"),this.off=this._get("off"),this.done=this._get("done"),this.trigger=this._get("trigger"),this.paneActive=this._get("paneActive"),this._set("plugins",{}),l.init.call(this);for(let t of["html","css","js"])this.load(t);if(n.showBlank)for(let t of["html","css","js"])a.addClass(h,r.hasFileClass(t))}findFile(t){var e=this._get("options");for(let s in e.files){let a=e.files[s];if(a.type===t)return a}return{}}markup(t){var e=this._get("$container"),s=e.querySelector(`.coder-pane-${t}`),i=this.findFile(t),n=document.createElement("div");n.innerHTML=r.editorContent(t,i.url),n.className=r.editorClass(t),s.appendChild(n),this._get("$status")[t]=s.querySelector(".coder-status"),void 0===i.url&&void 0===i.content||a.addClass(e,r.hasFileClass(t))}load(t){var e=this.findFile(t),s=this._get("$container").querySelector(`.coder-pane-${t} textarea`);void 0!==e.content?this.setValue(s,e.content):void 0!==e.url?(this.status("loading",[r.statusLoading(e.url)],{type:t,file:e}),n.fetch(e.url,(e,a)=>{e?this.status("error",[r.statusFetchError(e)],{type:t}):(this.clearStatus("loading",{type:t}),this.setValue(s,a))})):this.setValue(s,"")}setValue(t,e){t.value=e,this.change({target:t})}change(t){var e=i.data(t.target,"coder-type");if(e){var s=this._get("cachedContent");s[e]!==t.target.value&&(s[e]=t.target.value,this.trigger("change",{type:e,file:i.data(t.target,"coder-file"),content:s[e]}))}}errors(t,e){this.status("error",t,e)}pane(t){if(i.data(t.target,"coder-type")){var e=this._get("$container"),s=this._get("paneActive");a.removeClass(e,r.paneActiveClass(s)),s=this._set("paneActive",i.data(t.target,"coder-type")),a.addClass(e,r.paneActiveClass(s)),t.preventDefault()}}status(t="error",e=[],s={}){if(!e.length)return this.clearStatus(t,s);var i=this._get("$status");a.addClass(i[s.type],r.statusClass(t)),a.addClass(this._get("$container"),r.statusActiveClass(s.type));var n="";e.forEach(function(t){n+=r.statusMessage(t)}),i[s.type].innerHTML=n}clearStatus(t,e){var s=this._get("$status");a.removeClass(s[e.type],r.statusClass(t)),a.removeClass(this._get("$container"),r.statusActiveClass(e.type)),s[e.type].innerHTML=""}trigger(){var t=this._get("options"),e=this._get("pubsoup");if(!1===t.debounce)return function(){e.publish.apply(e,arguments)};var s={},a={};return function(i,{type:n="default"}={}){s[n]?a[n]=!0:e.publish.apply(e,arguments),clearTimeout(s[n]),s[n]=setTimeout(()=>{a[n]&&e.publish.apply(e,arguments),a[n]=null,s[n]=null},t.debounce)}}}return h.plugin=function(){return l.register.apply(this,arguments)},t.attach("widgets.Coder",h)});
//# sourceMappingURL=sourcemaps/Coder.js.map
