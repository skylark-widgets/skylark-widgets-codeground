{"version":3,"sources":["addons/general/console.js"],"names":["define","langx","styler","Addon","util","addons","PluginConsole","options","autoClear","[object Object]","super","_init","coder","this","logCaptureSnippet","capture","toString","$nav","document","createElement","addClass","innerHTML","$pane","$container","appendChild","querySelector","$output","$input","$inputForm","$clear","addEventListener","submit","bind","history","clear","on","priority","change","window","getMessage","$coderContainer","historyIndex","contentCache","html","css","js","getIframe","e","source","contentWindow","data","JSON","parse","err","type","log","message","params","callback","snippetlessContent","content","replace","forceRender","indexOf","console","oldConsoleLog","Function","prototype","call","slice","arguments","forEach","parent","postMessage","stringify","apply","$log","inputValue","value","trim","preventDefault","push","length","scriptOutput","eval","scrollTop","scrollHeight","gotHistory","selectionStart","keyCode","categoryName","addonName","general"],"mappings":";;;;;;;AAAAA,QACI,sBACA,sBACA,cACA,aACA,gBACD,SAAUC,EAAMC,EAAOC,EAAMC,EAAKC,GACjC,mBAEMC,UAAuBH,EAGzBI,cACI,OACGC,WAAW,GAIlBC,QACIC,MAAMC,QACN,IAAIC,EAAQC,KAAKD,MACbL,EAAUM,KAAKN,QAKfO,eAAkCD,KAAKE,QAAQC,iBAM/CC,EAAOC,SAASC,cAAc,MAClCjB,EAAOkB,SAASH,EAAM,yCACtBA,EAAKI,UAAY,uDACjB,IAAIC,EAAQJ,SAASC,cAAc,OACnCjB,EAAOkB,SAASE,EAAO,iCACvBA,EAAMD,UAAY,uVAUlBT,EAAMW,WAAWC,YAAYF,GAC7BV,EAAMW,WAAWE,cAAc,cAAcD,YAAYP,GACzD,IAAIM,EAAaX,EAAMW,WAAWE,cAAc,4BAC5CC,EAAUd,EAAMW,WAAWE,cAAc,yBACzCE,EAASf,EAAMW,WAAWE,cAAc,8BACxCG,EAAahB,EAAMW,WAAWE,cAAc,wBAC5CI,EAASjB,EAAMW,WAAWE,cAAc,wBAC5CG,EAAWE,iBAAiB,SAAUjB,KAAKkB,OAAOC,KAAKnB,OACvDc,EAAOG,iBAAiB,UAAWjB,KAAKoB,QAAQD,KAAKnB,OACrDgB,EAAOC,iBAAiB,QAASjB,KAAKqB,MAAMF,KAAKnB,QACvB,IAAtBN,EAAQC,WACRI,EAAMuB,GAAG,SAAUtB,KAAKL,UAAUwB,KAAKnB,MAAOuB,IAElDxB,EAAMuB,GAAG,SAAUtB,KAAKwB,OAAOL,KAAKnB,MArCrB,IAsCfyB,OAAOR,iBAAiB,UAAWjB,KAAK0B,WAAWP,KAAKnB,OACxDA,KAAK2B,gBAAkB5B,EAAMW,WAC7BV,KAAKU,WAAaA,EAClBV,KAAKc,OAASA,EACdd,KAAKa,QAAUA,EACfb,KAAKoB,WACLpB,KAAK4B,aA1Cc,EA2CnB5B,KAAKC,kBAAoBA,EACzBD,KAAK6B,cAzCDC,KAAM,GACNC,IAAK,GACLC,GAAI,IAwCRhC,KAAKiC,UAAYjC,KAAKiC,UAAUd,KAAKnB,MAEzCJ,YACI,OAAOI,KAAK2B,gBAAgBf,cAAc,6BAE9ChB,WAAWsC,GACP,GAAIA,EAAEC,SAAWnC,KAAKiC,YAAYG,cAAlC,CAGA,IAAIC,KACJ,IACIA,EAAOC,KAAKC,MAAML,EAAEG,MACtB,MAAOG,IAES,sBAAdH,EAAKI,MACLzC,KAAK0C,IAAIL,EAAKM,UAGtB/C,UAAUgD,EAAQC,GACd,IAAIC,EAAqBF,EAAOG,QACZ,OAAhBH,EAAOH,OACPK,EAAqBA,EAAmBE,QAAQhD,KAAKC,kBAAmB,MAEjD,IAAvB2C,EAAOK,aAAwBjD,KAAK6B,aAAae,EAAOH,QAAUK,GAClE9C,KAAKqB,QAETrB,KAAK6B,aAAae,EAAOH,MAAQK,EAGrClD,OAAOsC,GACH,IAAIU,EAASV,EAAEG,KACK,OAAhBO,EAAOH,OAG6C,IAApDG,EAAOG,QAAQG,QAAQlD,KAAKC,qBAC5B2C,EAAOG,WAAc/C,KAAKC,oBAAsB2C,EAAOG,WAI/DnD,eACkC,IAAnB6B,OAAO0B,cAAyD,IAAvB1B,OAAO0B,QAAQT,MAC/DjB,OAAO0B,SACHT,IAAK,eAIb,IAAIU,EAAgBC,SAASC,UAAUnC,KAAKoC,KAAK9B,OAAO0B,QAAQT,IAAKjB,OAAO0B,SAC5E1B,OAAO0B,QAAQT,IAAM,cACdc,MAAMD,KAAKE,WAAWC,QAAQ,SAAUf,GACvClB,OAAOkC,OAAOC,YAAYtB,KAAKuB,WAC3BpB,KAAM,oBACNE,QAASA,IACT,OAERS,EAAcU,MAAMV,EAAeK,YAG3C7D,IAAI+C,EAAU,GAAIF,GACd,IAAIsB,EAAO1D,SAASC,cAAc,MAClCjB,EAAOkB,SAASwD,EAAM,0BACF,IAATtB,GACPpD,EAAOkB,SAASwD,uBAA4BtB,KAEhDsB,EAAKvD,UAAYmC,EACjB3C,KAAKa,QAAQF,YAAYoD,GAE7BnE,OAAOsC,GACH,IAAI8B,EAAahE,KAAKc,OAAOmD,MAAMC,OACnC,GAAmB,KAAfF,EACA,OAAO9B,EAAEiC,iBAEbnE,KAAKoB,QAAQgD,KAAKJ,GAClBhE,KAAK4B,aAAe5B,KAAKoB,QAAQiD,OACjCrE,KAAK0C,IAAIsB,EAAY,WACgB,IAAjCA,EAAWd,QAAQ,YACnBc,EAAa,UAAYA,GAE7B,IACI,IAAIM,EAAetE,KAAKiC,YAAYG,cAAcmC,qBAAsBP,SACxEhE,KAAK0C,IAAI4B,GACX,MAAO9B,GACLxC,KAAK0C,IAAIF,EAAK,SAElBxC,KAAKc,OAAOmD,MAAQ,GACpBjE,KAAKU,WAAW8D,UAAYxE,KAAKU,WAAW+D,aAC5CvC,EAAEiC,iBAENvE,QACII,KAAKa,QAAQL,UAAY,GAE7BZ,QAAQsC,GACJ,IAEIwC,GAAa,EACbC,EAAiB3E,KAAKc,OAAO6D,eAHxB,KAILzC,EAAE0C,SAAwC,IAAtB5E,KAAK4B,cAAyC,IAAnB+C,IAC/C3E,KAAK4B,eACL8C,GAAa,GALN,KAOPxC,EAAE0C,SAAoB5E,KAAK4B,eAAiB5B,KAAKoB,QAAQiD,OAAS,GAAKM,IAAmB3E,KAAKc,OAAOmD,MAAMI,SAC5GrE,KAAK4B,eACL8C,GAAa,GAEbA,IACA1E,KAAKc,OAAOmD,MAAQjE,KAAKoB,QAAQpB,KAAK4B,eAI9CiD,0BACI,MAAO,UAGXC,uBACI,MAAO,WAOf,OAFAtF,EAAOuF,QAAQ5B,QAAU1D,EAElBA","file":"../../../addons/general/console.js","sourcesContent":["define([\n    'skylark-langx/langx',\n    \"skylark-domx-styler\",\n    \"../../Addon\",\n    '../../util',\n    \"../../addons\"\n], function (langx,styler,Addon,util,addons) {\n    'use strict';\n    \n    class PluginConsole  extends Addon{\n        //constructor(coder, options) \n\n        get options() {\n            return {\n               autoClear: false \n            }\n        }\n\n        _init() {\n            super._init();\n            var coder = this.coder,\n                options = this.options;\n            \n            var priority = 30;\n            var history = [];\n            var historyIndex = 0;\n            var logCaptureSnippet = `(function ${ this.capture.toString() })();`;\n            var contentCache = {\n                html: '',\n                css: '',\n                js: ''\n            };\n            var $nav = document.createElement('li');\n            styler.addClass($nav, 'coder-nav-item coder-nav-item-console');\n            $nav.innerHTML = '<a href=\"#\" data-coder-type=\"console\">JS Console</a>';\n            var $pane = document.createElement('div');\n            styler.addClass($pane, 'coder-pane coder-pane-console');\n            $pane.innerHTML = `\n              <div class=\"coder-console-container\">\n                <ul class=\"coder-console-output\"></ul>\n                <form class=\"coder-console-input\">\n                  <input type=\"text\">\n                </form>\n              </div>\n              <button class=\"coder-button coder-console-clear\">Clear</button>\n            `;\n\n            coder.$container.appendChild($pane);\n            coder.$container.querySelector('.coder-nav').appendChild($nav);\n            var $container = coder.$container.querySelector('.coder-console-container');\n            var $output = coder.$container.querySelector('.coder-console-output');\n            var $input = coder.$container.querySelector('.coder-console-input input');\n            var $inputForm = coder.$container.querySelector('.coder-console-input');\n            var $clear = coder.$container.querySelector('.coder-console-clear');\n            $inputForm.addEventListener('submit', this.submit.bind(this));\n            $input.addEventListener('keydown', this.history.bind(this));\n            $clear.addEventListener('click', this.clear.bind(this));\n            if (options.autoClear === true) {\n                coder.on('change', this.autoClear.bind(this), priority - 1);\n            }\n            coder.on('change', this.change.bind(this), priority);\n            window.addEventListener('message', this.getMessage.bind(this));\n            this.$coderContainer = coder.$container;\n            this.$container = $container;\n            this.$input = $input;\n            this.$output = $output;\n            this.history = history;\n            this.historyIndex = historyIndex;\n            this.logCaptureSnippet = logCaptureSnippet;\n            this.contentCache = contentCache;\n            this.getIframe = this.getIframe.bind(this);\n        }\n        getIframe() {\n            return this.$coderContainer.querySelector('.coder-pane-result iframe');\n        }\n        getMessage(e) {\n            if (e.source !== this.getIframe().contentWindow) {\n                return;\n            }\n            var data = {};\n            try {\n                data = JSON.parse(e.data);\n            } catch (err) {\n            }\n            if (data.type === 'coder-console-log') {\n                this.log(data.message);\n            }\n        }\n        autoClear(params, callback) {\n            var snippetlessContent = params.content;\n            if (params.type === 'js') {\n                snippetlessContent = snippetlessContent.replace(this.logCaptureSnippet, '');\n            }\n            if (params.forceRender === true || this.contentCache[params.type] !== snippetlessContent) {\n                this.clear();\n            }\n            this.contentCache[params.type] = snippetlessContent;\n            //callback(null, params);\n        }\n        change(e) {\n            var params = e.data;\n            if (params.type !== 'js') {\n                return //callback(null, params);\n            }\n            if (params.content.indexOf(this.logCaptureSnippet) === -1) {\n                params.content = `${ this.logCaptureSnippet }${ params.content }`;\n            }\n            //callback(null, params);\n        }\n        capture() {\n            if (typeof window.console === 'undefined' || typeof window.console.log === 'undefined') {\n                window.console = {\n                    log: function () {\n                    }\n                };\n            }\n            var oldConsoleLog = Function.prototype.bind.call(window.console.log, window.console);\n            window.console.log = function () {\n                [].slice.call(arguments).forEach(function (message) {\n                    window.parent.postMessage(JSON.stringify({\n                        type: 'coder-console-log',\n                        message: message\n                    }), '*');\n                });\n                oldConsoleLog.apply(oldConsoleLog, arguments);\n            };\n        }\n        log(message = '', type) {\n            var $log = document.createElement('li');\n            styler.addClass($log, 'coder-console-log');\n            if (typeof type !== 'undefined') {\n                styler.addClass($log, `coder-console-log-${ type }`);\n            }\n            $log.innerHTML = message;\n            this.$output.appendChild($log);\n        }\n        submit(e) {\n            var inputValue = this.$input.value.trim();\n            if (inputValue === '') {\n                return e.preventDefault();\n            }\n            this.history.push(inputValue);\n            this.historyIndex = this.history.length;\n            this.log(inputValue, 'history');\n            if (inputValue.indexOf('return') !== 0) {\n                inputValue = 'return ' + inputValue;\n            }\n            try {\n                var scriptOutput = this.getIframe().contentWindow.eval(`(function() {${ inputValue }})()`);\n                this.log(scriptOutput);\n            } catch (err) {\n                this.log(err, 'error');\n            }\n            this.$input.value = '';\n            this.$container.scrollTop = this.$container.scrollHeight;\n            e.preventDefault();\n        }\n        clear() {\n            this.$output.innerHTML = '';\n        }\n        history(e) {\n            var UP = 38;\n            var DOWN = 40;\n            var gotHistory = false;\n            var selectionStart = this.$input.selectionStart;\n            if (e.keyCode === UP && this.historyIndex !== 0 && selectionStart === 0) {\n                this.historyIndex--;\n                gotHistory = true;\n            }\n            if (e.keyCode === DOWN && this.historyIndex !== this.history.length - 1 && selectionStart === this.$input.value.length) {\n                this.historyIndex++;\n                gotHistory = true;\n            }\n            if (gotHistory) {\n                this.$input.value = this.history[this.historyIndex];\n            }\n        }\n\n        static get categoryName() {\n            return \"general\";\n        }\n\n        static get addonName(){\n            return \"console\";\n        }\n        \n    };\n\n    addons.general.console = PluginConsole;\n\n    return PluginConsole;\n});"]}