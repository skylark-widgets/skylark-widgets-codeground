/**
 * skylark-ui-coder - The skylark coder widget
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylarkui/skylark-ui-coder/
 * @license MIT
 */
define(["skylark-langx/Evented","../CoderCtor"],function(e,t){e.inherit({klassName:"ContentEditableInput",_construct:function(e){this.cm=e,this.lastAnchorNode=this.lastAnchorOffset=this.lastFocusNode=this.lastFocusOffset=null,this.polling=new Delayed,this.gracePeriod=!1},init:function(e){function t(e){if(!signalDOMEvent(n,e)){if(n.somethingSelected())lastCopied={lineWise:!1,text:n.getSelections()},"cut"==e.type&&n.replaceSelection("",null,"cut");else{if(!n.options.lineWiseCopyCut)return;var t=copyableRanges(n);lastCopied={lineWise:!0,text:t.text},"cut"==e.type&&n.operation(function(){n.setSelections(t.ranges,0,sel_dontScroll),n.replaceSelection("",null,"cut")})}if(e.clipboardData&&!ios)e.preventDefault(),e.clipboardData.clearData(),e.clipboardData.setData("text/plain",lastCopied.text.join("\n"));else{var o=hiddenTextarea(),i=o.firstChild;n.display.lineSpace.insertBefore(o,n.display.lineSpace.firstChild),i.value=lastCopied.text.join("\n");var s=document.activeElement;selectInput(i),setTimeout(function(){n.display.lineSpace.removeChild(o),s.focus()},50)}}}var o=this,n=o.cm,i=o.div=e.lineDiv;disableBrowserMagic(i),on(i,"paste",function(e){signalDOMEvent(n,e)||handlePaste(e,n)}),on(i,"compositionstart",function(e){var t=e.data;if(o.composing={sel:n.doc.sel,data:t,startData:t},t){var i=n.doc.sel.primary(),s=n.getLine(i.head.line),c=s.indexOf(t,Math.max(0,i.head.ch-t.length));c>-1&&c<=i.head.ch&&(o.composing.sel=simpleSelection(Pos(i.head.line,c),Pos(i.head.line,c+t.length)))}}),on(i,"compositionupdate",function(e){o.composing.data=e.data}),on(i,"compositionend",function(e){var t=o.composing;t&&(e.data==t.startData||/\u200b/.test(e.data)||(t.data=e.data),setTimeout(function(){t.handled||o.applyComposition(t),o.composing==t&&(o.composing=null)},50))}),on(i,"touchstart",function(){o.forceCompositionEnd()}),on(i,"input",function(){o.composing||!n.isReadOnly()&&o.pollContent()||runInOp(o.cm,function(){regChange(n)})}),on(i,"copy",t),on(i,"cut",t)},prepareSelection:function(){var e=prepareSelection(this.cm,!1);return e.focus=this.cm.state.focused,e},showSelection:function(e,t){e&&this.cm.display.view.length&&((e.focus||t)&&this.showPrimarySelection(),this.showMultipleSelections(e))},showPrimarySelection:function(){var e=window.getSelection(),t=this.cm.doc.sel.primary(),o=domToPos(this.cm,e.anchorNode,e.anchorOffset),n=domToPos(this.cm,e.focusNode,e.focusOffset);if(!o||o.bad||!n||n.bad||0!=cmp(minPos(o,n),t.from())||0!=cmp(maxPos(o,n),t.to())){var i=posToDOM(this.cm,t.from()),s=posToDOM(this.cm,t.to());if(i||s){var c=this.cm.display.view,a=e.rangeCount&&e.getRangeAt(0);if(i){if(!s){var l=c[c.length-1].measure,r=l.maps?l.maps[l.maps.length-1]:l.map;s={node:r[r.length-1],offset:r[r.length-2]-r[r.length-3]}}}else i={node:c[0].measure.map[2],offset:0};try{var d=range(i.node,i.offset,s.offset,s.node)}catch(h){}d&&(!gecko&&this.cm.state.focused?(e.collapse(i.node,i.offset),d.collapsed||e.addRange(d)):(e.removeAllRanges(),e.addRange(d)),a&&null==e.anchorNode?e.addRange(a):gecko&&this.startGracePeriod()),this.rememberSelection()}}},startGracePeriod:function(){var e=this;clearTimeout(this.gracePeriod),this.gracePeriod=setTimeout(function(){e.gracePeriod=!1,e.selectionChanged()&&e.cm.operation(function(){e.cm.curOp.selectionChanged=!0})},20)},showMultipleSelections:function(e){removeChildrenAndAdd(this.cm.display.cursorDiv,e.cursors),removeChildrenAndAdd(this.cm.display.selectionDiv,e.selection)},rememberSelection:function(){var e=window.getSelection();this.lastAnchorNode=e.anchorNode,this.lastAnchorOffset=e.anchorOffset,this.lastFocusNode=e.focusNode,this.lastFocusOffset=e.focusOffset},selectionInEditor:function(){var e=window.getSelection();if(!e.rangeCount)return!1;var t=e.getRangeAt(0).commonAncestorContainer;return contains(this.div,t)},focus:function(){"nocursor"!=this.cm.options.readOnly&&this.div.focus()},blur:function(){this.div.blur()},getField:function(){return this.div},supportsTouch:function(){return!0},receivedFocus:function(){function e(){t.cm.state.focused&&(t.pollSelection(),t.polling.set(t.cm.options.pollInterval,e))}var t=this;this.selectionInEditor()?this.pollSelection():runInOp(this.cm,function(){t.cm.curOp.selectionChanged=!0}),this.polling.set(this.cm.options.pollInterval,e)},selectionChanged:function(){var e=window.getSelection();return e.anchorNode!=this.lastAnchorNode||e.anchorOffset!=this.lastAnchorOffset||e.focusNode!=this.lastFocusNode||e.focusOffset!=this.lastFocusOffset},pollSelection:function(){if(!this.composing&&!this.gracePeriod&&this.selectionChanged()){var e=window.getSelection(),t=this.cm;this.rememberSelection();var o=domToPos(t,e.anchorNode,e.anchorOffset),n=domToPos(t,e.focusNode,e.focusOffset);o&&n&&runInOp(t,function(){setSelection(t.doc,simpleSelection(o,n),sel_dontScroll),(o.bad||n.bad)&&(t.curOp.selectionChanged=!0)})}},pollContent:function(){var e=this.cm,t=e.display,o=e.doc.sel.primary(),n=o.from(),i=o.to();if(n.line<t.viewFrom||i.line>t.viewTo-1)return!1;var s;if(n.line==t.viewFrom||0==(s=findViewIndex(e,n.line)))var c=lineNo(t.view[0].line),a=t.view[0].node;else var c=lineNo(t.view[s].line),a=t.view[s-1].node.nextSibling;var l=findViewIndex(e,i.line);if(l==t.view.length-1)var r=t.viewTo-1,d=t.lineDiv.lastChild;else var r=lineNo(t.view[l+1].line)-1,d=t.view[l+1].node.previousSibling;for(var h=e.doc.splitLines(domTextBetween(e,a,d,c,r)),f=getBetween(e.doc,Pos(c,0),Pos(r,getLine(e.doc,r).text.length));h.length>1&&f.length>1;)if(lst(h)==lst(f))h.pop(),f.pop(),r--;else{if(h[0]!=f[0])break;h.shift(),f.shift(),c++}for(var u=0,p=0,m=h[0],g=f[0],v=Math.min(m.length,g.length);u<v&&m.charCodeAt(u)==g.charCodeAt(u);)++u;for(var C=lst(h),S=lst(f),w=Math.min(C.length-(1==h.length?u:0),S.length-(1==f.length?u:0));p<w&&C.charCodeAt(C.length-p-1)==S.charCodeAt(S.length-p-1);)++p;h[h.length-1]=C.slice(0,C.length-p),h[0]=h[0].slice(u);var y=Pos(c,u),O=Pos(r,f.length?lst(f).length-p:0);return h.length>1||h[0]||cmp(y,O)?(replaceRange(e.doc,h,y,O,"+input"),!0):void 0},ensurePolled:function(){this.forceCompositionEnd()},reset:function(){this.forceCompositionEnd()},forceCompositionEnd:function(){this.composing&&!this.composing.handled&&(this.applyComposition(this.composing),this.composing.handled=!0,this.div.blur(),this.div.focus())},applyComposition:function(e){this.cm.isReadOnly()?operation(this.cm,regChange)(this.cm):e.data&&e.data!=e.startData&&operation(this.cm,applyTextInput)(this.cm,e.data,0,e.sel)},setUneditable:function(e){e.contentEditable="false"},onKeyPress:function(e){e.preventDefault(),this.cm.isReadOnly()||operation(this.cm,applyTextInput)(this.cm,String.fromCharCode(null==e.charCode?e.keyCode:e.charCode),0)},readOnlyChanged:function(e){this.div.contentEditable=String("nocursor"!=e)},onContextMenu:nothing,resetPosition:nothing,needsContentAttribute:!0})});
//# sourceMappingURL=../../sourcemaps/primitives/input/ContentEditableInput.js.map
