/**
 * skylark-ui-coder - The skylark coder widget
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylarkui/skylark-ui-coder/
 * @license MIT
 */
define(["skylark-langx/Evented","../CoderCtor"],function(e,t){function n(){var e=elt("textarea",null,null,"position: absolute; bottom: -1em; padding: 0; width: 1px; height: 1em; outline: none"),t=elt("div",[e],null,"overflow: hidden; position: relative; width: 3px; height: 0px;");return webkit?e.style.width="1000px":e.setAttribute("wrap","off"),ios&&(e.style.border="1px solid black"),disableBrowserMagic(e),t}var i=e.inherit({klassName:"TextareaInput",_construct:function(e){this.cm=e,this.prevInput="",this.pollingFast=!1,this.polling=new Delayed,this.inaccurateSelection=!1,this.hasSelection=!1,this.composing=null},init:function(e){function t(e){if(!signalDOMEvent(o,e)){if(o.somethingSelected())lastCopied={lineWise:!1,text:o.getSelections()},i.inaccurateSelection&&(i.prevInput="",i.inaccurateSelection=!1,l.value=lastCopied.text.join("\n"),selectInput(l));else{if(!o.options.lineWiseCopyCut)return;var t=copyableRanges(o);lastCopied={lineWise:!0,text:t.text},"cut"==e.type?o.setSelections(t.ranges,null,sel_dontScroll):(i.prevInput="",l.value=t.text.join("\n"),selectInput(l))}"cut"==e.type&&(o.state.cutIncoming=!0)}}var i=this,o=this.cm,s=this.wrapper=n(),l=this.textarea=s.firstChild;e.wrapper.insertBefore(s,e.wrapper.firstChild),ios&&(l.style.width="0px"),on(l,"input",function(){ie&&ie_version>=9&&i.hasSelection&&(i.hasSelection=null),i.poll()}),on(l,"paste",function(e){signalDOMEvent(o,e)||handlePaste(e,o)||(o.state.pasteIncoming=!0,i.fastPoll())}),on(l,"cut",t),on(l,"copy",t),on(e.scroller,"paste",function(t){eventInWidget(e,t)||signalDOMEvent(o,t)||(o.state.pasteIncoming=!0,i.focus())}),on(e.lineSpace,"selectstart",function(t){eventInWidget(e,t)||e_preventDefault(t)}),on(l,"compositionstart",function(){var e=o.getCursor("from");i.composing&&i.composing.range.clear(),i.composing={start:e,range:o.markText(e,o.getCursor("to"),{className:"CodeMirror-composing"})}}),on(l,"compositionend",function(){i.composing&&(i.poll(),i.composing.range.clear(),i.composing=null)})},prepareSelection:function(){var e=this.cm,t=e.display,n=e.doc,i=prepareSelection(e);if(e.options.moveInputWithCursor){var o=cursorCoords(e,n.sel.primary().head,"div"),s=t.wrapper.getBoundingClientRect(),l=t.lineDiv.getBoundingClientRect();i.teTop=Math.max(0,Math.min(t.wrapper.clientHeight-10,o.top+l.top-s.top)),i.teLeft=Math.max(0,Math.min(t.wrapper.clientWidth-10,o.left+l.left-s.left))}return i},showSelection:function(e){var t=this.cm,n=t.display;removeChildrenAndAdd(n.cursorDiv,e.cursors),removeChildrenAndAdd(n.selectionDiv,e.selection),null!=e.teTop&&(this.wrapper.style.top=e.teTop+"px",this.wrapper.style.left=e.teLeft+"px")},reset:function(e){if(!this.contextMenuPending){var t,n,i=this.cm,o=i.doc;if(i.somethingSelected()){this.prevInput="";var s=o.sel.primary();t=hasCopyEvent&&(s.to().line-s.from().line>100||(n=i.getSelection()).length>1e3);var l=t?"-":n||i.getSelection();this.textarea.value=l,i.state.focused&&selectInput(this.textarea),ie&&ie_version>=9&&(this.hasSelection=l)}else e||(this.prevInput=this.textarea.value="",ie&&ie_version>=9&&(this.hasSelection=null));this.inaccurateSelection=t}},getField:function(){return this.textarea},supportsTouch:function(){return!1},focus:function(){if("nocursor"!=this.cm.options.readOnly&&(!mobile||activeElt()!=this.textarea))try{this.textarea.focus()}catch(e){}},blur:function(){this.textarea.blur()},resetPosition:function(){this.wrapper.style.top=this.wrapper.style.left=0},receivedFocus:function(){this.slowPoll()},slowPoll:function(){var e=this;e.pollingFast||e.polling.set(this.cm.options.pollInterval,function(){e.poll(),e.cm.state.focused&&e.slowPoll()})},fastPoll:function(){function e(){var i=n.poll();i||t?(n.pollingFast=!1,n.slowPoll()):(t=!0,n.polling.set(60,e))}var t=!1,n=this;n.pollingFast=!0,n.polling.set(20,e)},poll:function(){var e=this.cm,t=this.textarea,n=this.prevInput;if(this.contextMenuPending||!e.state.focused||hasSelection(t)&&!n&&!this.composing||e.isReadOnly()||e.options.disableInput||e.state.keySeq)return!1;var i=t.value;if(i==n&&!e.somethingSelected())return!1;if(ie&&ie_version>=9&&this.hasSelection===i||mac&&/[\uf700-\uf7ff]/.test(i))return e.display.input.reset(),!1;if(e.doc.sel==e.display.selForContextMenu){var o=i.charCodeAt(0);if(8203!=o||n||(n="​"),8666==o)return this.reset(),this.cm.execCommand("undo")}for(var s=0,l=Math.min(n.length,i.length);s<l&&n.charCodeAt(s)==i.charCodeAt(s);)++s;var r=this;return runInOp(e,function(){applyTextInput(e,i.slice(s),n.length-s,null,r.composing?"*compose":null),i.length>1e3||i.indexOf("\n")>-1?t.value=r.prevInput="":r.prevInput=i,r.composing&&(r.composing.range.clear(),r.composing.range=e.markText(r.composing.start,e.getCursor("to"),{className:"CodeMirror-composing"}))}),!0},ensurePolled:function(){this.pollingFast&&this.poll()&&(this.pollingFast=!1)},onKeyPress:function(){ie&&ie_version>=9&&(this.hasSelection=null),this.fastPoll()},onContextMenu:function(e){function t(){if(null!=l.selectionStart){var e=o.somethingSelected(),t="​"+(e?l.value:"");l.value="⇚",l.value=t,i.prevInput=e?"":"​",l.selectionStart=1,l.selectionEnd=t.length,s.selForContextMenu=o.doc.sel}}function n(){if(i.contextMenuPending=!1,i.wrapper.style.cssText=u,l.style.cssText=p,ie&&ie_version<9&&s.scrollbars.setScrollTop(s.scroller.scrollTop=a),null!=l.selectionStart){(!ie||ie&&ie_version<9)&&t();var e=0,n=function(){s.selForContextMenu==o.doc.sel&&0==l.selectionStart&&l.selectionEnd>0&&"​"==i.prevInput?operation(o,commands.selectAll)(o):e++<10?s.detectingSelectAll=setTimeout(n,500):s.input.reset()};s.detectingSelectAll=setTimeout(n,200)}}var i=this,o=i.cm,s=o.display,l=i.textarea,r=posFromMouse(o,e),a=s.scroller.scrollTop;if(r&&!presto){var c=o.options.resetSelectionOnContextMenu;c&&o.doc.sel.contains(r)==-1&&operation(o,setSelection)(o.doc,simpleSelection(r),sel_dontScroll);var p=l.style.cssText,u=i.wrapper.style.cssText;i.wrapper.style.cssText="position: absolute";var h=i.wrapper.getBoundingClientRect();if(l.style.cssText="position: absolute; width: 30px; height: 30px; top: "+(e.clientY-h.top-5)+"px; left: "+(e.clientX-h.left-5)+"px; z-index: 1000; background: "+(ie?"rgba(255, 255, 255, .05)":"transparent")+"; outline: none; border-width: 0; outline: none; overflow: hidden; opacity: .05; filter: alpha(opacity=5);",webkit)var d=window.scrollY;if(s.input.focus(),webkit&&window.scrollTo(null,d),s.input.reset(),o.somethingSelected()||(l.value=i.prevInput=" "),i.contextMenuPending=!0,s.selForContextMenu=o.doc.sel,clearTimeout(s.detectingSelectAll),ie&&ie_version>=9&&t(),captureRightClick){e_stop(e);var f=function(){off(window,"mouseup",f),setTimeout(n,20)};on(window,"mouseup",f)}else setTimeout(n,50)}},readOnlyChanged:function(e){e||this.reset()},setUneditable:nothing,needsContentAttribute:!1});return i});
//# sourceMappingURL=../../sourcemaps/primitives/input/TextareaInput.js.map
