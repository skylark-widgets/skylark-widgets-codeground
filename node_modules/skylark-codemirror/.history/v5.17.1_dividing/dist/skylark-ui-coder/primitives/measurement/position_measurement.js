/**
 * skylark-ui-coder - The skylark coder widget
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylarkui/skylark-ui-coder/
 * @license MIT
 */
define(["../CoderCtor"],function(e){function t(e,t,r){if(e.line==t)return{map:e.measure.map,cache:e.measure.cache};for(var i=0;i<e.rest.length;i++)if(e.rest[i]==t)return{map:e.measure.maps[i],cache:e.measure.caches[i]};for(var i=0;i<e.rest.length;i++)if(lineNo(e.rest[i])>r)return{map:e.measure.maps[i],cache:e.measure.caches[i],before:!0}}function r(e,t,r){for(var i,n,a,o,l=0;l<e.length;l+=3){var s=e[l],h=e[l+1];if(t<s?(n=0,a=1,o="left"):t<h?(n=t-s,a=n+1):(l==e.length-3||t==h&&e[l+3]>t)&&(a=h-s,n=a-1,t>=h&&(o="right")),null!=n){if(i=e[l+2],s==h&&r==(i.insertLeft?"left":"right")&&(o=r),"left"==r&&0==n)for(;l&&e[l-2]==e[l-3]&&e[l-1].insertLeft;)i=e[(l-=3)+2],o="left";if("right"==r&&n==h-s)for(;l<e.length-3&&e[l+3]==e[l+4]&&!e[l+5].insertLeft;)i=e[(l+=3)+2],o="right";break}}return{node:i,start:n,end:a,collapse:o,coverStart:s,coverEnd:h}}function i(e,t){var r=h;if("left"==t)for(var i=0;i<e.length&&(r=e[i]).left==r.right;i++);else for(var i=e.length-1;i>=0&&(r=e[i]).left==r.right;i--);return r}function n(e,t){if(!window.screen||null==screen.logicalXDPI||screen.logicalXDPI==screen.deviceXDPI||!hasBadZoomedRects(e))return t;var r=screen.logicalXDPI/screen.deviceXDPI,i=screen.logicalYDPI/screen.deviceYDPI;return{left:t.left*r,right:t.right*r,top:t.top*i,bottom:t.bottom*i}}function a(e){if(e.measure&&(e.measure.cache={},e.measure.heights=null,e.rest))for(var t=0;t<e.rest.length;t++)e.measure.caches[t]={}}function o(){return window.pageXOffset||(document.documentElement||document.body).scrollLeft}function l(){return window.pageYOffset||(document.documentElement||document.body).scrollTop}function s(e,t,r,i){var n=Pos(e,t);return n.xRel=i,r&&(n.outside=!0),n}e.partial({getDimensions:function(){for(var e=this,t=e.display,r={},i={},n=t.gutters.clientLeft,a=t.gutters.firstChild,o=0;a;a=a.nextSibling,++o)r[e.options.gutters[o]]=a.offsetLeft+a.clientLeft+n,i[e.options.gutters[o]]=a.clientWidth;return{fixedPos:compensateForHScroll(t),gutterTotalWidth:t.gutters.offsetWidth,gutterLeft:r,gutterWidth:i,wrapperWidth:t.wrapper.clientWidth}},scrollGap:function(){var e=this;return scrollerGap-e.display.nativeBarWidth},displayWidth:function(){var e=this;return e.display.scroller.clientWidth-e.scrollGap()-e.display.barWidth},displayHeight:function(){var e=this;return e.display.scroller.clientHeight-e.scrollGap()-e.display.barHeight},ensureLineHeights:function(e,t){var r=this,i=r.options.lineWrapping,n=i&&r.displayWidth();if(!e.measure.heights||i&&e.measure.width!=n){var a=e.measure.heights=[];if(i){e.measure.width=n;for(var o=e.text.firstChild.getClientRects(),l=0;l<o.length-1;l++){var s=o[l],h=o[l+1];Math.abs(s.bottom-h.bottom)>2&&a.push((s.bottom+h.top)/2-t.top)}}a.push(t.bottom-t.top)}},updateExternalMeasurement:function(e){var t=this;e=visualLine(e);var r=e.lineNo(),i=t.display.externalMeasured=new LineView(t.doc,e,r);i.lineN=r;var n=i.built=t.buildLineContent(i);return i.text=n.pre,removeChildrenAndAdd(t.display.lineMeasure,n.pre),i},measureChar:function(e,t,r){var i=this;return i.measureCharPrepared(i.prepareMeasureForLine(e),t,r)},findViewForLine:function(e){var t=this;if(e>=t.display.viewFrom&&e<t.display.viewTo)return t.display.view[findViewIndex(t,e)];var r=t.display.externalMeasured;return r&&e>=r.lineN&&e<r.lineN+r.size?r:void 0},prepareMeasureForLine:function(e){var r=this,i=e.lineNo(),n=r.findViewForLine(i);n&&!n.text?n=null:n&&n.changes&&(r.updateLineForChanges(n,i,r.getDimensions()),r.curOp.forceUpdate=!0),n||(n=r.updateExternalMeasurement(e));var a=t(n,e,i);return{line:e,view:n,rect:null,map:a.map,cache:a.cache,before:a.before,hasHeights:!1}},measureCharPrepared:function(e,t,r,i){var n=this;e.before&&(t=-1);var a,o=t+(r||"");return e.cache.hasOwnProperty(o)?a=e.cache[o]:(e.rect||(e.rect=e.view.text.getBoundingClientRect()),e.hasHeights||(n.ensureLineHeights(e.view,e.rect),e.hasHeights=!0),a=n.measureCharInner(e,t,r),a.bogus||(e.cache[o]=a)),{left:a.left,right:a.right,top:i?a.rtop:a.top,bottom:i?a.rbottom:a.bottom}},measureCharInner:function(e,t,a){var o,l=this,s=r(e.map,t,a),c=s.node,d=s.start,f=s.end,u=s.collapse;if(3==c.nodeType){for(var g=0;g<4;g++){for(;d&&isExtendingChar(e.line.text.charAt(s.coverStart+d));)--d;for(;s.coverStart+f<s.coverEnd&&isExtendingChar(e.line.text.charAt(s.coverStart+f));)++f;if(o=ie&&ie_version<9&&0==d&&f==s.coverEnd-s.coverStart?c.parentNode.getBoundingClientRect():i(range(c,d,f).getClientRects(),a),o.left||o.right||0==d)break;f=d,d-=1,u="right"}ie&&ie_version<11&&(o=n(l.display.measure,o))}else{d>0&&(u=a="right");var p;o=l.options.lineWrapping&&(p=c.getClientRects()).length>1?p["right"==a?p.length-1:0]:c.getBoundingClientRect()}if(ie&&ie_version<9&&!d&&(!o||!o.left&&!o.right)){var v=c.parentNode.getClientRects()[0];o=v?{left:v.left,right:v.left+charWidth(l.display),top:v.top,bottom:v.bottom}:h}for(var m=o.top-e.rect.top,y=o.bottom-e.rect.top,w=(m+y)/2,C=e.view.measure.heights,g=0;g<C.length-1&&!(w<C[g]);g++);var b=g?C[g-1]:0,x=C[g],L={left:("right"==u?o.right:o.left)-e.rect.left,right:("left"==u?o.left:o.right)-e.rect.left,top:b,bottom:x};return o.left||o.right||(L.bogus=!0),l.options.singleCursorHeightPerLine||(L.rtop=m,L.rbottom=y),L},clearLineMeasurementCache:function(e){var e=this;e.display.externalMeasure=null,removeChildren(e.display.lineMeasure);for(var t=0;t<e.display.view.length;t++)a(e.display.view[t])},clearCaches:function(){var e=this;clearLineMeasurementCache(e),e.display.cachedCharWidth=e.display.cachedTextHeight=e.display.cachedPaddingH=null,e.options.lineWrapping||(e.display.maxLineChanged=!0),e.display.lineNumChars=null},intoCoordSystem:function(e,t,r){var i=this;if(e.widgets)for(var n=0;n<e.widgets.length;++n)if(e.widgets[n].above){var a=widgetHeight(e.widgets[n]);t.top+=a,t.bottom+=a}if("line"==r)return t;r||(r="local");var s=heightAtLine(e);if("local"==r?s+=paddingTop(i.display):s-=i.display.viewOffset,"page"==r||"window"==r){var h=i.display.lineSpace.getBoundingClientRect();s+=h.top+("window"==r?0:l());var c=h.left+("window"==r?0:o());t.left+=c,t.right+=c}return t.top+=s,t.bottom+=s,t},fromCoordSystem:function(e,t){var r=this;if("div"==t)return e;var i=e.left,n=e.top;if("page"==t)i-=o(),n-=l();else if("local"==t||!t){var a=r.display.sizer.getBoundingClientRect();i+=a.left,n+=a.top}var s=r.display.lineSpace.getBoundingClientRect();return{left:i-s.left,top:n-s.top}},coordsChar:function(e,t){var r=this,i=r.doc;if(t+=r.display.viewOffset,t<0)return s(i.first,0,!0,-1);var n=lineAtHeight(i,t),a=i.first+i.size-1;if(n>a)return s(i.first+i.size-1,getLine(i,a).text.length,!0,1);e<0&&(e=0);for(var o=getLine(i,n);;){var l=r.coordsCharInner(o,n,e,t),h=collapsedSpanAtEnd(o),c=h&&h.find(0,!0);if(!h||!(l.ch>c.from.ch||l.ch==c.from.ch&&l.xRel>0))return l;n=lineNo(o=c.to.line)}},coordsCharInner:function(e,t,r,i){function n(r){var i=a.cursorCoords(Pos(t,r),"line",e,c);return l=!0,o>i.bottom?i.left-h:o<i.top?i.left+h:(l=!1,i.left)}var a=this,o=i-heightAtLine(e),l=!1,h=2*a.display.wrapper.clientWidth,c=a.prepareMeasureForLine(e),d=getOrder(e),f=e.text.length,u=lineLeft(e),g=lineRight(e),p=n(u),v=l,m=n(g),y=l;if(r>m)return s(t,g,y,1);for(;;){if(d?g==u||g==moveVisually(e,u,1):g-u<=1){var w=r<p||r-p<=m-r?u:g,C=w==u?v:y,b=r-(w==u?p:m);if(y&&!d&&!/\s/.test(e.text.charAt(w))&&b>0&&w<e.text.length&&c.view.measure.heights.length>1){var x=measureCharPrepared(a,c,w,"right");o<=x.bottom&&o>=x.top&&Math.abs(r-x.right)<b&&(C=!1,w++,b=r-x.right)}for(;isExtendingChar(e.text.charAt(w));)++w;var L=s(t,w,C,b<-1?-1:b>1?1:0);return L}var H=Math.ceil(f/2),W=u+H;if(d){W=u;for(var M=0;M<H;++M)W=moveVisually(e,W,1)}var P=n(W);P>r?(g=W,m=P,(y=l)&&(m+=1e3),f=H):(u=W,p=P,v=l,f-=H)}},posFromMouse:function(e,t,r){var i=this,n=i.display;if(!t&&"true"==e_target(e).getAttribute("cm-not-content"))return null;var a,o,l=n.lineSpace.getBoundingClientRect();try{a=e.clientX-l.left,o=e.clientY-l.top}catch(e){return null}var s,h=coordsChar(i,a,o);if(r&&1==h.xRel&&(s=getLine(i.doc,h.line).text).length==h.ch){var c=countColumn(s,s.length,i.options.tabSize)-s.length;h=Pos(h.line,Math.max(0,Math.round((a-paddingH(i.display).left)/charWidth(i.display))-c))}return h},estimateHeight:function(){var e=this,t=e.display.textHeight(),r=e.options.lineWrapping,i=r&&Math.max(5,e.display.scroller.clientWidth/charWidth(e.display)-3);return function(n){if(lineIsHidden(e.doc,n))return 0;var a=0;if(n.widgets)for(var o=0;o<n.widgets.length;o++)n.widgets[o].height&&(a+=n.widgets[o].height);return r?a+(Math.ceil(n.text.length/i)||1)*t:a+t}},estimateLineHeights:function(){var e=this,t=e.doc,r=e.estimateHeight();t.iter(function(e){var t=r(e);t!=e.height&&updateLineHeight(e,t)})}});var h={left:0,right:0,top:0,bottom:0}});
//# sourceMappingURL=../../sourcemaps/primitives/measurement/position_measurement.js.map
