{"version":3,"sources":["addon/scroll/annotatescrollbar.js"],"names":["define","CodeMirror","Annotation","cm","options","scheduleRedraw","delay","clearTimeout","self","doRedraw","setTimeout","redraw","this","buttonHeight","scrollButtonHeight","getOption","annotations","doUpdate","div","getWrapperElement","appendChild","document","createElement","style","cssText","computeScale","on","resizeHandler","listenForChanges","changeHandler","defineExtension","className","defineOption","prototype","hScale","clientHeight","display","barHeight","getScrollerElement","scrollHeight","update","compute","getY","pos","top","curLine","line","curLineObj","getLineHandle","wrapping","height","singleLineH","charCoords","topY","heightAtLine","frag","createDocumentFragment","anns","defaultTextHeight","barWidth","nextTop","i","length","ann","from","bottom","to","Math","max","elt","id","setAttribute","textContent","clear","off","parentNode","removeChild"],"mappings":"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","file":"../../../addon/scroll/annotatescrollbar.js","sourcesContent":["// CodeMirror, copyright (c) by Marijn Haverbeke and others\n// Distributed under an MIT license: http://codemirror.net/LICENSE\n\ndefine([\"../../Coder\"], function(CodeMirror) {\n  \"use strict\";\n\n  CodeMirror.defineExtension(\"annotateScrollbar\", function(options) {\n    if (typeof options == \"string\") options = {className: options};\n    return new Annotation(this, options);\n  });\n\n  CodeMirror.defineOption(\"scrollButtonHeight\", 0);\n\n  function Annotation(cm, options) {\n    this.cm = cm;\n    this.options = options;\n    this.buttonHeight = options.scrollButtonHeight || cm.getOption(\"scrollButtonHeight\");\n    this.annotations = [];\n    this.doRedraw = this.doUpdate = null;\n    this.div = cm.getWrapperElement().appendChild(document.createElement(\"div\"));\n    this.div.style.cssText = \"position: absolute; right: 0; top: 0; z-index: 7; pointer-events: none\";\n    this.computeScale();\n\n    function scheduleRedraw(delay) {\n      clearTimeout(self.doRedraw);\n      self.doRedraw = setTimeout(function() { self.redraw(); }, delay);\n    }\n\n    var self = this;\n    cm.on(\"refresh\", this.resizeHandler = function() {\n      clearTimeout(self.doUpdate);\n      self.doUpdate = setTimeout(function() {\n        if (self.computeScale()) scheduleRedraw(20);\n      }, 100);\n    });\n    cm.on(\"markerAdded\", this.resizeHandler);\n    cm.on(\"markerCleared\", this.resizeHandler);\n    if (options.listenForChanges !== false)\n      cm.on(\"change\", this.changeHandler = function() {\n        scheduleRedraw(250);\n      });\n  }\n\n  Annotation.prototype.computeScale = function() {\n    var cm = this.cm;\n    var hScale = (cm.getWrapperElement().clientHeight - cm.display.barHeight - this.buttonHeight * 2) /\n      cm.getScrollerElement().scrollHeight\n    if (hScale != this.hScale) {\n      this.hScale = hScale;\n      return true;\n    }\n  };\n\n  Annotation.prototype.update = function(annotations) {\n    this.annotations = annotations;\n    this.redraw();\n  };\n\n  Annotation.prototype.redraw = function(compute) {\n    if (compute !== false) this.computeScale();\n    var cm = this.cm, hScale = this.hScale;\n\n    var frag = document.createDocumentFragment(), anns = this.annotations;\n\n    var wrapping = cm.getOption(\"lineWrapping\");\n    var singleLineH = wrapping && cm.defaultTextHeight() * 1.5;\n    var curLine = null, curLineObj = null;\n    function getY(pos, top) {\n      if (curLine != pos.line) {\n        curLine = pos.line;\n        curLineObj = cm.getLineHandle(curLine);\n      }\n      if (wrapping && curLineObj.height > singleLineH)\n        return cm.charCoords(pos, \"local\")[top ? \"top\" : \"bottom\"];\n      var topY = cm.heightAtLine(curLineObj, \"local\");\n      return topY + (top ? 0 : curLineObj.height);\n    }\n\n    if (cm.display.barWidth) for (var i = 0, nextTop; i < anns.length; i++) {\n      var ann = anns[i];\n      var top = nextTop || getY(ann.from, true) * hScale;\n      var bottom = getY(ann.to, false) * hScale;\n      while (i < anns.length - 1) {\n        nextTop = getY(anns[i + 1].from, true) * hScale;\n        if (nextTop > bottom + .9) break;\n        ann = anns[++i];\n        bottom = getY(ann.to, false) * hScale;\n      }\n      if (bottom == top) continue;\n      var height = Math.max(bottom - top, 3);\n\n      var elt = frag.appendChild(document.createElement(\"div\"));\n      elt.style.cssText = \"position: absolute; right: 0px; width: \" + Math.max(cm.display.barWidth - 1, 2) + \"px; top: \"\n        + (top + this.buttonHeight) + \"px; height: \" + height + \"px\";\n      elt.className = this.options.className;\n      if (ann.id) {\n        elt.setAttribute(\"annotation-id\", ann.id);\n      }\n    }\n    this.div.textContent = \"\";\n    this.div.appendChild(frag);\n  };\n\n  Annotation.prototype.clear = function() {\n    this.cm.off(\"refresh\", this.resizeHandler);\n    this.cm.off(\"markerAdded\", this.resizeHandler);\n    this.cm.off(\"markerCleared\", this.resizeHandler);\n    if (this.changeHandler) this.cm.off(\"change\", this.changeHandler);\n    this.div.parentNode.removeChild(this.div);\n  };\n});\n"]}