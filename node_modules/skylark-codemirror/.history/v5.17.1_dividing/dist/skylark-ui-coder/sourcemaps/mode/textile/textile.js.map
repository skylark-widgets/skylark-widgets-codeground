{"version":3,"sources":["mode/textile/textile.js"],"names":["mod","exports","module","require","define","amd","CodeMirror","startNewLine","stream","state","mode","Modes","newLayout","tableHeading","layoutType","spanningLayout","match","RE","handlePhraseModifier","ch","eat","togglePhraseModifier","footCite","tokenStyles","spec","tokenStylesWith","TOKEN_STYLES","specialChar","html","type","phraseModifier","closeRE","openSize","charBefore","pos","string","charAt","charAfter","peek","test","RegExp","source","attributes","disabled","textileDisabled","styles","push","concat","activeStyles","header","length","join","notextile","extraStyles","i","arguments","blankLine","key","hasOwnProperty","name","REs","cache","createRe","addition","bold","cite","code","definitionList","deletion","div","em","footnote","image","italic","link","linkDefinition","list1","list2","list3","pre","p","quote","span","strong","sub","sup","table","single","bc","bq","definitionListEnd","drawTable","foot","list","para","tableCellAttributes","tableText","text","align","selector","lang","pad","css","makeRe","choiceRe","pattern","arg","parts","unshift","apply","blockType","newMode","parseInt","next","layoutLength","listDepth","listMod","skipToEnd","tableCell","defineMode","startState","token","sol","defineMIME"],"mappings":"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","file":"../../../mode/textile/textile.js","sourcesContent":["// CodeMirror, copyright (c) by Marijn Haverbeke and others\n// Distributed under an MIT license: http://codemirror.net/LICENSE\n\n(function(mod) {\n  if (typeof exports == \"object\" && typeof module == \"object\") { // CommonJS\n    mod(require(\"../../Coder\"));\n  } else if (typeof define == \"function\" && define.amd) { // AMD\n    define([\"../../Coder\"], mod);\n  } else { // Plain browser env\n    mod(CodeMirror);\n  }\n})(function(CodeMirror) {\n  \"use strict\";\n\n  var TOKEN_STYLES = {\n    addition: \"positive\",\n    attributes: \"attribute\",\n    bold: \"strong\",\n    cite: \"keyword\",\n    code: \"atom\",\n    definitionList: \"number\",\n    deletion: \"negative\",\n    div: \"punctuation\",\n    em: \"em\",\n    footnote: \"variable\",\n    footCite: \"qualifier\",\n    header: \"header\",\n    html: \"comment\",\n    image: \"string\",\n    italic: \"em\",\n    link: \"link\",\n    linkDefinition: \"link\",\n    list1: \"variable-2\",\n    list2: \"variable-3\",\n    list3: \"keyword\",\n    notextile: \"string-2\",\n    pre: \"operator\",\n    p: \"property\",\n    quote: \"bracket\",\n    span: \"quote\",\n    specialChar: \"tag\",\n    strong: \"strong\",\n    sub: \"builtin\",\n    sup: \"builtin\",\n    table: \"variable-3\",\n    tableHeading: \"operator\"\n  };\n\n  function startNewLine(stream, state) {\n    state.mode = Modes.newLayout;\n    state.tableHeading = false;\n\n    if (state.layoutType === \"definitionList\" && state.spanningLayout &&\n        stream.match(RE(\"definitionListEnd\"), false))\n      state.spanningLayout = false;\n  }\n\n  function handlePhraseModifier(stream, state, ch) {\n    if (ch === \"_\") {\n      if (stream.eat(\"_\"))\n        return togglePhraseModifier(stream, state, \"italic\", /__/, 2);\n      else\n        return togglePhraseModifier(stream, state, \"em\", /_/, 1);\n    }\n\n    if (ch === \"*\") {\n      if (stream.eat(\"*\")) {\n        return togglePhraseModifier(stream, state, \"bold\", /\\*\\*/, 2);\n      }\n      return togglePhraseModifier(stream, state, \"strong\", /\\*/, 1);\n    }\n\n    if (ch === \"[\") {\n      if (stream.match(/\\d+\\]/)) state.footCite = true;\n      return tokenStyles(state);\n    }\n\n    if (ch === \"(\") {\n      var spec = stream.match(/^(r|tm|c)\\)/);\n      if (spec)\n        return tokenStylesWith(state, TOKEN_STYLES.specialChar);\n    }\n\n    if (ch === \"<\" && stream.match(/(\\w+)[^>]+>[^<]+<\\/\\1>/))\n      return tokenStylesWith(state, TOKEN_STYLES.html);\n\n    if (ch === \"?\" && stream.eat(\"?\"))\n      return togglePhraseModifier(stream, state, \"cite\", /\\?\\?/, 2);\n\n    if (ch === \"=\" && stream.eat(\"=\"))\n      return togglePhraseModifier(stream, state, \"notextile\", /==/, 2);\n\n    if (ch === \"-\" && !stream.eat(\"-\"))\n      return togglePhraseModifier(stream, state, \"deletion\", /-/, 1);\n\n    if (ch === \"+\")\n      return togglePhraseModifier(stream, state, \"addition\", /\\+/, 1);\n\n    if (ch === \"~\")\n      return togglePhraseModifier(stream, state, \"sub\", /~/, 1);\n\n    if (ch === \"^\")\n      return togglePhraseModifier(stream, state, \"sup\", /\\^/, 1);\n\n    if (ch === \"%\")\n      return togglePhraseModifier(stream, state, \"span\", /%/, 1);\n\n    if (ch === \"@\")\n      return togglePhraseModifier(stream, state, \"code\", /@/, 1);\n\n    if (ch === \"!\") {\n      var type = togglePhraseModifier(stream, state, \"image\", /(?:\\([^\\)]+\\))?!/, 1);\n      stream.match(/^:\\S+/); // optional Url portion\n      return type;\n    }\n    return tokenStyles(state);\n  }\n\n  function togglePhraseModifier(stream, state, phraseModifier, closeRE, openSize) {\n    var charBefore = stream.pos > openSize ? stream.string.charAt(stream.pos - openSize - 1) : null;\n    var charAfter = stream.peek();\n    if (state[phraseModifier]) {\n      if ((!charAfter || /\\W/.test(charAfter)) && charBefore && /\\S/.test(charBefore)) {\n        var type = tokenStyles(state);\n        state[phraseModifier] = false;\n        return type;\n      }\n    } else if ((!charBefore || /\\W/.test(charBefore)) && charAfter && /\\S/.test(charAfter) &&\n               stream.match(new RegExp(\"^.*\\\\S\" + closeRE.source + \"(?:\\\\W|$)\"), false)) {\n      state[phraseModifier] = true;\n      state.mode = Modes.attributes;\n    }\n    return tokenStyles(state);\n  };\n\n  function tokenStyles(state) {\n    var disabled = textileDisabled(state);\n    if (disabled) return disabled;\n\n    var styles = [];\n    if (state.layoutType) styles.push(TOKEN_STYLES[state.layoutType]);\n\n    styles = styles.concat(activeStyles(\n      state, \"addition\", \"bold\", \"cite\", \"code\", \"deletion\", \"em\", \"footCite\",\n      \"image\", \"italic\", \"link\", \"span\", \"strong\", \"sub\", \"sup\", \"table\", \"tableHeading\"));\n\n    if (state.layoutType === \"header\")\n      styles.push(TOKEN_STYLES.header + \"-\" + state.header);\n\n    return styles.length ? styles.join(\" \") : null;\n  }\n\n  function textileDisabled(state) {\n    var type = state.layoutType;\n\n    switch(type) {\n    case \"notextile\":\n    case \"code\":\n    case \"pre\":\n      return TOKEN_STYLES[type];\n    default:\n      if (state.notextile)\n        return TOKEN_STYLES.notextile + (type ? (\" \" + TOKEN_STYLES[type]) : \"\");\n      return null;\n    }\n  }\n\n  function tokenStylesWith(state, extraStyles) {\n    var disabled = textileDisabled(state);\n    if (disabled) return disabled;\n\n    var type = tokenStyles(state);\n    if (extraStyles)\n      return type ? (type + \" \" + extraStyles) : extraStyles;\n    else\n      return type;\n  }\n\n  function activeStyles(state) {\n    var styles = [];\n    for (var i = 1; i < arguments.length; ++i) {\n      if (state[arguments[i]])\n        styles.push(TOKEN_STYLES[arguments[i]]);\n    }\n    return styles;\n  }\n\n  function blankLine(state) {\n    var spanningLayout = state.spanningLayout, type = state.layoutType;\n\n    for (var key in state) if (state.hasOwnProperty(key))\n      delete state[key];\n\n    state.mode = Modes.newLayout;\n    if (spanningLayout) {\n      state.layoutType = type;\n      state.spanningLayout = true;\n    }\n  }\n\n  var REs = {\n    cache: {},\n    single: {\n      bc: \"bc\",\n      bq: \"bq\",\n      definitionList: /- [^(?::=)]+:=+/,\n      definitionListEnd: /.*=:\\s*$/,\n      div: \"div\",\n      drawTable: /\\|.*\\|/,\n      foot: /fn\\d+/,\n      header: /h[1-6]/,\n      html: /\\s*<(?:\\/)?(\\w+)(?:[^>]+)?>(?:[^<]+<\\/\\1>)?/,\n      link: /[^\"]+\":\\S/,\n      linkDefinition: /\\[[^\\s\\]]+\\]\\S+/,\n      list: /(?:#+|\\*+)/,\n      notextile: \"notextile\",\n      para: \"p\",\n      pre: \"pre\",\n      table: \"table\",\n      tableCellAttributes: /[\\/\\\\]\\d+/,\n      tableHeading: /\\|_\\./,\n      tableText: /[^\"_\\*\\[\\(\\?\\+~\\^%@|-]+/,\n      text: /[^!\"_=\\*\\[\\(<\\?\\+~\\^%@-]+/\n    },\n    attributes: {\n      align: /(?:<>|<|>|=)/,\n      selector: /\\([^\\(][^\\)]+\\)/,\n      lang: /\\[[^\\[\\]]+\\]/,\n      pad: /(?:\\(+|\\)+){1,2}/,\n      css: /\\{[^\\}]+\\}/\n    },\n    createRe: function(name) {\n      switch (name) {\n      case \"drawTable\":\n        return REs.makeRe(\"^\", REs.single.drawTable, \"$\");\n      case \"html\":\n        return REs.makeRe(\"^\", REs.single.html, \"(?:\", REs.single.html, \")*\", \"$\");\n      case \"linkDefinition\":\n        return REs.makeRe(\"^\", REs.single.linkDefinition, \"$\");\n      case \"listLayout\":\n        return REs.makeRe(\"^\", REs.single.list, RE(\"allAttributes\"), \"*\\\\s+\");\n      case \"tableCellAttributes\":\n        return REs.makeRe(\"^\", REs.choiceRe(REs.single.tableCellAttributes,\n                                            RE(\"allAttributes\")), \"+\\\\.\");\n      case \"type\":\n        return REs.makeRe(\"^\", RE(\"allTypes\"));\n      case \"typeLayout\":\n        return REs.makeRe(\"^\", RE(\"allTypes\"), RE(\"allAttributes\"),\n                          \"*\\\\.\\\\.?\", \"(\\\\s+|$)\");\n      case \"attributes\":\n        return REs.makeRe(\"^\", RE(\"allAttributes\"), \"+\");\n\n      case \"allTypes\":\n        return REs.choiceRe(REs.single.div, REs.single.foot,\n                            REs.single.header, REs.single.bc, REs.single.bq,\n                            REs.single.notextile, REs.single.pre, REs.single.table,\n                            REs.single.para);\n\n      case \"allAttributes\":\n        return REs.choiceRe(REs.attributes.selector, REs.attributes.css,\n                            REs.attributes.lang, REs.attributes.align, REs.attributes.pad);\n\n      default:\n        return REs.makeRe(\"^\", REs.single[name]);\n      }\n    },\n    makeRe: function() {\n      var pattern = \"\";\n      for (var i = 0; i < arguments.length; ++i) {\n        var arg = arguments[i];\n        pattern += (typeof arg === \"string\") ? arg : arg.source;\n      }\n      return new RegExp(pattern);\n    },\n    choiceRe: function() {\n      var parts = [arguments[0]];\n      for (var i = 1; i < arguments.length; ++i) {\n        parts[i * 2 - 1] = \"|\";\n        parts[i * 2] = arguments[i];\n      }\n\n      parts.unshift(\"(?:\");\n      parts.push(\")\");\n      return REs.makeRe.apply(null, parts);\n    }\n  };\n\n  function RE(name) {\n    return (REs.cache[name] || (REs.cache[name] = REs.createRe(name)));\n  }\n\n  var Modes = {\n    newLayout: function(stream, state) {\n      if (stream.match(RE(\"typeLayout\"), false)) {\n        state.spanningLayout = false;\n        return (state.mode = Modes.blockType)(stream, state);\n      }\n      var newMode;\n      if (!textileDisabled(state)) {\n        if (stream.match(RE(\"listLayout\"), false))\n          newMode = Modes.list;\n        else if (stream.match(RE(\"drawTable\"), false))\n          newMode = Modes.table;\n        else if (stream.match(RE(\"linkDefinition\"), false))\n          newMode = Modes.linkDefinition;\n        else if (stream.match(RE(\"definitionList\")))\n          newMode = Modes.definitionList;\n        else if (stream.match(RE(\"html\"), false))\n          newMode = Modes.html;\n      }\n      return (state.mode = (newMode || Modes.text))(stream, state);\n    },\n\n    blockType: function(stream, state) {\n      var match, type;\n      state.layoutType = null;\n\n      if (match = stream.match(RE(\"type\")))\n        type = match[0];\n      else\n        return (state.mode = Modes.text)(stream, state);\n\n      if (match = type.match(RE(\"header\"))) {\n        state.layoutType = \"header\";\n        state.header = parseInt(match[0][1]);\n      } else if (type.match(RE(\"bq\"))) {\n        state.layoutType = \"quote\";\n      } else if (type.match(RE(\"bc\"))) {\n        state.layoutType = \"code\";\n      } else if (type.match(RE(\"foot\"))) {\n        state.layoutType = \"footnote\";\n      } else if (type.match(RE(\"notextile\"))) {\n        state.layoutType = \"notextile\";\n      } else if (type.match(RE(\"pre\"))) {\n        state.layoutType = \"pre\";\n      } else if (type.match(RE(\"div\"))) {\n        state.layoutType = \"div\";\n      } else if (type.match(RE(\"table\"))) {\n        state.layoutType = \"table\";\n      }\n\n      state.mode = Modes.attributes;\n      return tokenStyles(state);\n    },\n\n    text: function(stream, state) {\n      if (stream.match(RE(\"text\"))) return tokenStyles(state);\n\n      var ch = stream.next();\n      if (ch === '\"')\n        return (state.mode = Modes.link)(stream, state);\n      return handlePhraseModifier(stream, state, ch);\n    },\n\n    attributes: function(stream, state) {\n      state.mode = Modes.layoutLength;\n\n      if (stream.match(RE(\"attributes\")))\n        return tokenStylesWith(state, TOKEN_STYLES.attributes);\n      else\n        return tokenStyles(state);\n    },\n\n    layoutLength: function(stream, state) {\n      if (stream.eat(\".\") && stream.eat(\".\"))\n        state.spanningLayout = true;\n\n      state.mode = Modes.text;\n      return tokenStyles(state);\n    },\n\n    list: function(stream, state) {\n      var match = stream.match(RE(\"list\"));\n      state.listDepth = match[0].length;\n      var listMod = (state.listDepth - 1) % 3;\n      if (!listMod)\n        state.layoutType = \"list1\";\n      else if (listMod === 1)\n        state.layoutType = \"list2\";\n      else\n        state.layoutType = \"list3\";\n\n      state.mode = Modes.attributes;\n      return tokenStyles(state);\n    },\n\n    link: function(stream, state) {\n      state.mode = Modes.text;\n      if (stream.match(RE(\"link\"))) {\n        stream.match(/\\S+/);\n        return tokenStylesWith(state, TOKEN_STYLES.link);\n      }\n      return tokenStyles(state);\n    },\n\n    linkDefinition: function(stream, state) {\n      stream.skipToEnd();\n      return tokenStylesWith(state, TOKEN_STYLES.linkDefinition);\n    },\n\n    definitionList: function(stream, state) {\n      stream.match(RE(\"definitionList\"));\n\n      state.layoutType = \"definitionList\";\n\n      if (stream.match(/\\s*$/))\n        state.spanningLayout = true;\n      else\n        state.mode = Modes.attributes;\n\n      return tokenStyles(state);\n    },\n\n    html: function(stream, state) {\n      stream.skipToEnd();\n      return tokenStylesWith(state, TOKEN_STYLES.html);\n    },\n\n    table: function(stream, state) {\n      state.layoutType = \"table\";\n      return (state.mode = Modes.tableCell)(stream, state);\n    },\n\n    tableCell: function(stream, state) {\n      if (stream.match(RE(\"tableHeading\")))\n        state.tableHeading = true;\n      else\n        stream.eat(\"|\");\n\n      state.mode = Modes.tableCellAttributes;\n      return tokenStyles(state);\n    },\n\n    tableCellAttributes: function(stream, state) {\n      state.mode = Modes.tableText;\n\n      if (stream.match(RE(\"tableCellAttributes\")))\n        return tokenStylesWith(state, TOKEN_STYLES.attributes);\n      else\n        return tokenStyles(state);\n    },\n\n    tableText: function(stream, state) {\n      if (stream.match(RE(\"tableText\")))\n        return tokenStyles(state);\n\n      if (stream.peek() === \"|\") { // end of cell\n        state.mode = Modes.tableCell;\n        return tokenStyles(state);\n      }\n      return handlePhraseModifier(stream, state, stream.next());\n    }\n  };\n\n  CodeMirror.defineMode(\"textile\", function() {\n    return {\n      startState: function() {\n        return { mode: Modes.newLayout };\n      },\n      token: function(stream, state) {\n        if (stream.sol()) startNewLine(stream, state);\n        return state.mode(stream, state);\n      },\n      blankLine: blankLine\n    };\n  });\n\n  CodeMirror.defineMIME(\"text/x-textile\", \"textile\");\n});\n"]}