{"version":3,"sources":["primitives/display/selection.js"],"names":["define","CoderCtor","partial","updateSelection","cm","this","display","input","showSelection","prepareSelection","primary","doc","result","curFragment","cursors","document","createDocumentFragment","selFragment","selection","i","sel","ranges","length","primIndex","range","from","line","viewTo","to","viewFrom","collapsed","empty","options","showCursorWhenSelecting","drawSelectionCursor","head","drawSelectionRange","output","pos","cursorCoords","singleCursorHeightPerLine","cursor","appendChild","elt","style","left","top","height","Math","max","bottom","cursorHeight","other","otherCursor","add","width","round","fragment","rightSide","drawForLine","fromArg","toArg","coords","ch","bias","charCoords","Pos","lineObj","start","end","getLine","lineLen","text","iterateBidiSections","getOrder","dir","rightPos","right","leftPos","tmp","leftSide","padding","paddingH","sizerWidth","displayWidth","sizer","offsetLeft","sFrom","sTo","fromLine","toLine","singleVLine","visualLine","leftEnd","rightStart","restartBlink","state","focused","clearInterval","blinker","on","cursorDiv","visibility","cursorBlinkRate","setInterval"],"mappings":"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","file":"../../../primitives/display/selection.js","sourcesContent":["define([\r\n  \"../CoderCtor\"\r\n],function(CoderCtor) {\r\n  // SELECTION DRAWING\r\n\r\n  CoderCtor.partial({\r\n    updateSelection :function () {\r\n      var cm = this;\r\n\r\n      cm.display.input.showSelection(cm.display.input.prepareSelection());\r\n    },\r\n\r\n    prepareSelection : function (primary) {\r\n      var cm = this;\r\n\r\n      var doc = cm.doc, result = {};\r\n      var curFragment = result.cursors = document.createDocumentFragment();\r\n      var selFragment = result.selection = document.createDocumentFragment();\r\n\r\n      for (var i = 0; i < doc.sel.ranges.length; i++) {\r\n        if (primary === false && i == doc.sel.primIndex) continue;\r\n        var range = doc.sel.ranges[i];\r\n        if (range.from().line >= cm.display.viewTo || range.to().line < cm.display.viewFrom) continue;\r\n        var collapsed = range.empty();\r\n        if (collapsed || cm.options.showCursorWhenSelecting)\r\n          cm.drawSelectionCursor(range.head, curFragment);\r\n        if (!collapsed)\r\n          cm.drawSelectionRange(range, selFragment);\r\n      }\r\n      return result;\r\n    },\r\n\r\n    // Draws a cursor for the given range\r\n    drawSelectionCursor : function (head, output) {\r\n      var cm = this;\r\n\r\n      var pos = cm.cursorCoords(head, \"div\", null, null, !cm.options.singleCursorHeightPerLine);\r\n\r\n      var cursor = output.appendChild(elt(\"div\", \"\\u00a0\", \"CodeMirror-cursor\"));\r\n      cursor.style.left = pos.left + \"px\";\r\n      cursor.style.top = pos.top + \"px\";\r\n      cursor.style.height = Math.max(0, pos.bottom - pos.top) * cm.options.cursorHeight + \"px\";\r\n\r\n      if (pos.other) {\r\n        // Secondary cursor, shown when on a 'jump' in bi-directional text\r\n        var otherCursor = output.appendChild(elt(\"div\", \"\\u00a0\", \"CodeMirror-cursor CodeMirror-secondarycursor\"));\r\n        otherCursor.style.display = \"\";\r\n        otherCursor.style.left = pos.other.left + \"px\";\r\n        otherCursor.style.top = pos.other.top + \"px\";\r\n        otherCursor.style.height = (pos.other.bottom - pos.other.top) * .85 + \"px\";\r\n      }\r\n    },\r\n\r\n    // Draws the given range as a highlighted selection\r\n    drawSelectionRange : function (range, output) {\r\n      var cm = this;\r\n\r\n      var display = cm.display, doc = cm.doc;\r\n      var fragment = document.createDocumentFragment();\r\n      var padding = paddingH(cm.display), leftSide = padding.left;\r\n      var rightSide = Math.max(display.sizerWidth, cm.displayWidth() - display.sizer.offsetLeft) - padding.right;\r\n\r\n      function add(left, top, width, bottom) {\r\n        if (top < 0) top = 0;\r\n        top = Math.round(top);\r\n        bottom = Math.round(bottom);\r\n        fragment.appendChild(elt(\"div\", null, \"CodeMirror-selected\", \"position: absolute; left: \" + left +\r\n                                 \"px; top: \" + top + \"px; width: \" + (width == null ? rightSide - left : width) +\r\n                                 \"px; height: \" + (bottom - top) + \"px\"));\r\n      }\r\n\r\n      function drawForLine(line, fromArg, toArg) {\r\n        var lineObj = getLine(doc, line);\r\n        var lineLen = lineObj.text.length;\r\n        var start, end;\r\n        function coords(ch, bias) {\r\n          return charCoords(cm, Pos(line, ch), \"div\", lineObj, bias);\r\n        }\r\n\r\n        iterateBidiSections(getOrder(lineObj), fromArg || 0, toArg == null ? lineLen : toArg, function(from, to, dir) {\r\n          var leftPos = coords(from, \"left\"), rightPos, left, right;\r\n          if (from == to) {\r\n            rightPos = leftPos;\r\n            left = right = leftPos.left;\r\n          } else {\r\n            rightPos = coords(to - 1, \"right\");\r\n            if (dir == \"rtl\") { var tmp = leftPos; leftPos = rightPos; rightPos = tmp; }\r\n            left = leftPos.left;\r\n            right = rightPos.right;\r\n          }\r\n          if (fromArg == null && from == 0) left = leftSide;\r\n          if (rightPos.top - leftPos.top > 3) { // Different lines, draw top part\r\n            add(left, leftPos.top, null, leftPos.bottom);\r\n            left = leftSide;\r\n            if (leftPos.bottom < rightPos.top) add(left, leftPos.bottom, null, rightPos.top);\r\n          }\r\n          if (toArg == null && to == lineLen) right = rightSide;\r\n          if (!start || leftPos.top < start.top || leftPos.top == start.top && leftPos.left < start.left)\r\n            start = leftPos;\r\n          if (!end || rightPos.bottom > end.bottom || rightPos.bottom == end.bottom && rightPos.right > end.right)\r\n            end = rightPos;\r\n          if (left < leftSide + 1) left = leftSide;\r\n          add(left, rightPos.top, right - left, rightPos.bottom);\r\n        });\r\n        return {start: start, end: end};\r\n      }\r\n\r\n      var sFrom = range.from(), sTo = range.to();\r\n      if (sFrom.line == sTo.line) {\r\n        drawForLine(sFrom.line, sFrom.ch, sTo.ch);\r\n      } else {\r\n        var fromLine = getLine(doc, sFrom.line), toLine = getLine(doc, sTo.line);\r\n        var singleVLine = visualLine(fromLine) == visualLine(toLine);\r\n        var leftEnd = drawForLine(sFrom.line, sFrom.ch, singleVLine ? fromLine.text.length + 1 : null).end;\r\n        var rightStart = drawForLine(sTo.line, singleVLine ? 0 : null, sTo.ch).start;\r\n        if (singleVLine) {\r\n          if (leftEnd.top < rightStart.top - 2) {\r\n            add(leftEnd.right, leftEnd.top, null, leftEnd.bottom);\r\n            add(leftSide, rightStart.top, rightStart.left, rightStart.bottom);\r\n          } else {\r\n            add(leftEnd.right, leftEnd.top, rightStart.left - leftEnd.right, leftEnd.bottom);\r\n          }\r\n        }\r\n        if (leftEnd.bottom < rightStart.top)\r\n          add(leftSide, leftEnd.bottom, null, rightStart.top);\r\n      }\r\n\r\n      output.appendChild(fragment);\r\n    },\r\n\r\n    // Cursor-blinking\r\n    restartBlink : function () {\r\n      var cm = this;\r\n\r\n      if (!cm.state.focused) return;\r\n      var display = cm.display;\r\n      clearInterval(display.blinker);\r\n      var on = true;\r\n      display.cursorDiv.style.visibility = \"\";\r\n      if (cm.options.cursorBlinkRate > 0)\r\n        display.blinker = setInterval(function() {\r\n          display.cursorDiv.style.visibility = (on = !on) ? \"\" : \"hidden\";\r\n        }, cm.options.cursorBlinkRate);\r\n      else if (cm.options.cursorBlinkRate < 0)\r\n        display.cursorDiv.style.visibility = \"hidden\";\r\n    }\r\n  });\r\n\r\n});\r\n"]}