{"version":3,"sources":["primitives/edit/drop_events.js"],"names":["define","browser","CoderCtor","lastDrop","partial","onDrop","e","cm","this","clearDragCursor","signalDOMEvent","eventInWidget","display","e_preventDefault","ie","Date","pos","posFromMouse","files","dataTransfer","isReadOnly","length","window","FileReader","File","n","text","Array","read","loadFile","file","i","options","allowDropFileTypes","indexOf","type","reader","onload","operation","content","result","test","clipPos","doc","change","from","to","splitLines","join","lineSeparator","origin","makeChange","setSelectionReplaceHistory","simpleSelection","changeEnd","readAsText","state","draggingText","sel","contains","setTimeout","input","focus","getData","copy","selected","listSelections","setSelectionNoUndo","replaceRange","anchor","head","replaceSelection","onDragStart","e_stop","setData","getSelection","effectAllowed","setDragImage","safari","img","elt","src","presto","width","height","wrapper","appendChild","_top","offsetTop","parentNode","removeChild","onDragOver","frag","document","createDocumentFragment","drawSelectionCursor","dragCursor","lineSpace","insertBefore","cursorDiv","removeChildrenAndAdd"],"mappings":"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","file":"../../../primitives/edit/drop_events.js","sourcesContent":["define([\r\n  \"../util/browser\",\r\n  \"../CoderCtor\"\r\n],function(browser, CoderCtor) {\r\n  // Kludge to work around strange IE behavior where it'll sometimes\r\n  // re-fire a series of drag-related events right after the drop (#1551)\r\n  var lastDrop = 0;\r\n\r\n  CoderCtor.partial({\r\n\r\n    onDrop : function (e) {\r\n      var cm = this;\r\n\r\n      cm.clearDragCursor();\r\n      \r\n      if (signalDOMEvent(cm, e) || eventInWidget(cm.display, e))\r\n        return;\r\n\r\n      e_preventDefault(e);\r\n      \r\n      if (ie) lastDrop = +new Date;\r\n      var pos = posFromMouse(cm, e, true), \r\n        files = e.dataTransfer.files;\r\n      \r\n      if (!pos || cm.isReadOnly()) return;\r\n      \r\n      // Might be a file drop, in which case we simply extract the text\r\n      // and insert it.\r\n      if (files && files.length && window.FileReader && window.File) {\r\n        var n = files.length, text = Array(n), read = 0;\r\n        var loadFile = function(file, i) {\r\n          if (cm.options.allowDropFileTypes &&\r\n              indexOf(cm.options.allowDropFileTypes, file.type) == -1)\r\n            return;\r\n\r\n          var reader = new FileReader;\r\n          reader.onload = operation(cm, function() {\r\n            var content = reader.result;\r\n            if (/[\\x00-\\x08\\x0e-\\x1f]{2}/.test(content)) content = \"\";\r\n            text[i] = content;\r\n            if (++read == n) {\r\n              pos = clipPos(cm.doc, pos);\r\n              var change = {from: pos, to: pos,\r\n                            text: cm.doc.splitLines(text.join(cm.doc.lineSeparator())),\r\n                            origin: \"paste\"};\r\n              makeChange(cm.doc, change);\r\n              setSelectionReplaceHistory(cm.doc, simpleSelection(pos, changeEnd(change)));\r\n            }\r\n          });\r\n          reader.readAsText(file);\r\n        };\r\n        for (var i = 0; i < n; ++i) {\r\n          loadFile(files[i], i);\r\n        }\r\n      } else { // Normal drop\r\n        // Don't do a replace if the drop happened inside of the selected text.\r\n        if (cm.state.draggingText && cm.doc.sel.contains(pos) > -1) {\r\n          cm.state.draggingText(e);\r\n          // Ensure the editor is re-focused\r\n          setTimeout(function() {cm.display.input.focus();}, 20);\r\n          return;\r\n        }\r\n        try {\r\n          var text = e.dataTransfer.getData(\"Text\");\r\n          if (text) {\r\n            if (cm.state.draggingText && !cm.state.draggingText.copy)\r\n              var selected = cm.listSelections();\r\n\r\n            setSelectionNoUndo(cm.doc, simpleSelection(pos, pos));\r\n\r\n            if (selected) {\r\n              for (var i = 0; i < selected.length; ++i) {\r\n                replaceRange(cm.doc, \"\", selected[i].anchor, selected[i].head, \"drag\");\r\n              }\r\n            }\r\n\r\n            cm.replaceSelection(text, \"around\", \"paste\");\r\n\r\n            cm.display.input.focus();\r\n          }\r\n        }\r\n        catch(e){}\r\n      }\r\n    },\r\n\r\n    onDragStart : function (e) {\r\n      var cm = this;\r\n\r\n      if (ie && (!cm.state.draggingText || +new Date - lastDrop < 100)) { e_stop(e); return; }\r\n      if (signalDOMEvent(cm, e) || eventInWidget(cm.display, e)) return;\r\n\r\n      e.dataTransfer.setData(\"Text\", cm.getSelection());\r\n      e.dataTransfer.effectAllowed = \"copyMove\"\r\n\r\n      // Use dummy image instead of default browsers image.\r\n      // Recent Safari (~6.0.2) have a tendency to segfault when this happens, so we don't do it there.\r\n      if (e.dataTransfer.setDragImage && !safari) {\r\n        var img = elt(\"img\", null, null, \"position: fixed; left: 0; top: 0;\");\r\n        img.src = \"data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==\";\r\n        if (presto) {\r\n          img.width = img.height = 1;\r\n          cm.display.wrapper.appendChild(img);\r\n          // Force a relayout, or Opera won't use our image for some obscure reason\r\n          img._top = img.offsetTop;\r\n        }\r\n        e.dataTransfer.setDragImage(img, 0, 0);\r\n        if (presto) img.parentNode.removeChild(img);\r\n      }\r\n    },\r\n\r\n    onDragOver : function (e) {\r\n      var cm = this;\r\n\r\n      var pos = posFromMouse(cm, e);\r\n      if (!pos) return;\r\n      var frag = document.createDocumentFragment();\r\n      drawSelectionCursor(cm, pos, frag);\r\n      if (!cm.display.dragCursor) {\r\n        cm.display.dragCursor = elt(\"div\", null, \"CodeMirror-cursors CodeMirror-dragcursors\");\r\n        cm.display.lineSpace.insertBefore(cm.display.dragCursor, cm.display.cursorDiv);\r\n      }\r\n      removeChildrenAndAdd(cm.display.dragCursor, frag);\r\n    },\r\n\r\n    clearDragCursor : function () {\r\n      var cm = this;\r\n\r\n      if (cm.display.dragCursor) {\r\n        cm.display.lineSpace.removeChild(cm.display.dragCursor);\r\n        cm.display.dragCursor = null;\r\n      }\r\n    }\r\n  });\r\n\r\n});\r\n"]}