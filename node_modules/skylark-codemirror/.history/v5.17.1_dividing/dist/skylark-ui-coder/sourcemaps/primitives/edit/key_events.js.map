{"version":3,"sources":["primitives/edit/key_events.js"],"names":["define","CoderCtor","stopSeq","Delayed","lastStoppedKey","partial","doHandleBinding","bound","dropShift","cm","this","commands","display","input","ensurePolled","prevShift","shift","done","isReadOnly","state","suppressEdits","Pass","lookupKeyForEditor","name","handle","i","keyMaps","length","result","lookupKey","options","extraKeys","keyMap","dispatchKey","e","seq","keySeq","isModifierKey","set","reset","signalLater","e_preventDefault","restartBlink","test","handleKeyBinding","keyName","shiftKey","b","motion","handleCharBinding","ch","onKeyDown","curOp","focus","activeElt","signalDOMEvent","ie","ie_version","keyCode","returnValue","code","handled","presto","hasCopyEvent","mac","metaKey","ctrlKey","replaceSelection","lineDiv","className","showCrossHair","up","altKey","rmClass","off","document","addClass","on","onKeyUp","doc","sel","onKeyPress","eventInWidget","charCode","which","String","fromCharCode"],"mappings":"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","file":"../../../primitives/edit/key_events.js","sourcesContent":["define([\r\n  \"../CoderCtor\"\r\n],function(CoderCtor) {\r\n  // KEY EVENTS\r\n  var stopSeq = new Delayed;\r\n    var lastStoppedKey = null;\r\n\r\n\r\n  CoderCtor.partial({\r\n    // Run a handler that was bound to a key.\r\n    doHandleBinding : function (bound, dropShift) {\r\n      var cm = this;\r\n\r\n      if (typeof bound == \"string\") {\r\n        bound = commands[bound];\r\n        if (!bound) return false;\r\n      }\r\n      // Ensure previous input has been read, so that the handler sees a\r\n      // consistent view of the document\r\n      cm.display.input.ensurePolled();\r\n      var prevShift = cm.display.shift, done = false;\r\n      try {\r\n        if (cm.isReadOnly()) cm.state.suppressEdits = true;\r\n        if (dropShift) cm.display.shift = false;\r\n        done = bound(cm) != Pass;\r\n      } finally {\r\n        cm.display.shift = prevShift;\r\n        cm.state.suppressEdits = false;\r\n      }\r\n      return done;\r\n    },\r\n\r\n    lookupKeyForEditor : function (name, handle) {\r\n      var cm = this;\r\n\r\n      for (var i = 0; i < cm.state.keyMaps.length; i++) {\r\n        var result = lookupKey(name, cm.state.keyMaps[i], handle, cm);\r\n        if (result) return result;\r\n      }\r\n      return (cm.options.extraKeys && lookupKey(name, cm.options.extraKeys, handle, cm))\r\n        || lookupKey(name, cm.options.keyMap, handle, cm);\r\n    },\r\n\r\n    dispatchKey : function (name, e, handle) {\r\n      var cm = this;\r\n\r\n      var seq = cm.state.keySeq;\r\n      if (seq) {\r\n        if (isModifierKey(name)) return \"handled\";\r\n        stopSeq.set(50, function() {\r\n          if (cm.state.keySeq == seq) {\r\n            cm.state.keySeq = null;\r\n            cm.display.input.reset();\r\n          }\r\n        });\r\n        name = seq + \" \" + name;\r\n      }\r\n      var result = cm.lookupKeyForEditor(name, handle);\r\n\r\n      if (result == \"multi\")\r\n        cm.state.keySeq = name;\r\n      if (result == \"handled\")\r\n        cm.signalLater(\"keyHandled\", cm, name, e);\r\n\r\n      if (result == \"handled\" || result == \"multi\") {\r\n        e_preventDefault(e);\r\n        cm.restartBlink();\r\n      }\r\n\r\n      if (seq && !result && /\\'$/.test(name)) {\r\n        e_preventDefault(e);\r\n        return true;\r\n      }\r\n      return !!result;\r\n    },\r\n\r\n    // Handle a key from the keydown event.\r\n    handleKeyBinding : function (e) {\r\n      var cm = this;\r\n\r\n      var name = keyName(e, true);\r\n      if (!name) return false;\r\n\r\n      if (e.shiftKey && !cm.state.keySeq) {\r\n        // First try to resolve full name (including 'Shift-'). Failing\r\n        // that, see if there is a cursor-motion command (starting with\r\n        // 'go') bound to the keyname without 'Shift-'.\r\n        return cm.dispatchKey(\"Shift-\" + name, e, function(b) {return cm.doHandleBinding( b, true);})\r\n            || cm.dispatchKey(name, e, function(b) {\r\n                 if (typeof b == \"string\" ? /^go[A-Z]/.test(b) : b.motion)\r\n                   return cm.doHandleBinding(b);\r\n               });\r\n      } else {\r\n        return cm.dispatchKey(name, e, function(b) { return cm.doHandleBinding(b); });\r\n      }\r\n    },\r\n\r\n    // Handle a key from the keypress event\r\n    handleCharBinding : function (e, ch) {\r\n      var cm = this;\r\n\r\n      return cm.dispatchKey(\"'\" + ch + \"'\", e,\r\n                         function(b) { return cm.doHandleBinding( b, true); });\r\n    },\r\n\r\n    onKeyDown :  function(e) {\r\n      var cm = this;\r\n\r\n      cm.curOp.focus = activeElt();\r\n      if (cm.signalDOMEvent(e)) return;\r\n      // IE does strange things with escape.\r\n      if (ie && ie_version < 11 && e.keyCode == 27) e.returnValue = false;\r\n      var code = e.keyCode;\r\n      cm.display.shift = code == 16 || e.shiftKey;\r\n      var handled = cm.handleKeyBinding( e);\r\n      if (presto) {\r\n        lastStoppedKey = handled ? code : null;\r\n        // Opera has no cut event... we try to at least catch the key combo\r\n        if (!handled && code == 88 && !hasCopyEvent && (mac ? e.metaKey : e.ctrlKey))\r\n          cm.replaceSelection(\"\", null, \"cut\");\r\n      }\r\n\r\n      // Turn mouse into crosshair when Alt is held on Mac.\r\n      if (code == 18 && !/\\bCodeMirror-crosshair\\b/.test(cm.display.lineDiv.className))\r\n        cm.showCrossHair();\r\n    },\r\n\r\n    showCrossHair : function () {\r\n      var cm = this;\r\n\r\n      var lineDiv = cm.display.lineDiv;\r\n      addClass(lineDiv, \"CodeMirror-crosshair\");\r\n\r\n      function up(e) {\r\n        if (e.keyCode == 18 || !e.altKey) {\r\n          rmClass(lineDiv, \"CodeMirror-crosshair\");\r\n          off(document, \"keyup\", up);\r\n          off(document, \"mouseover\", up);\r\n        }\r\n      }\r\n      on(document, \"keyup\", up);\r\n      on(document, \"mouseover\", up);\r\n    },\r\n\r\n    onKeyUp : function (e) {\r\n      if (e.keyCode == 16) this.doc.sel.shift = false;\r\n      signalDOMEvent(this, e);\r\n    },\r\n\r\n    onKeyPress :  function (e) {\r\n      var cm = this;\r\n\r\n      if (eventInWidget(cm.display, e) || cm.signalDOMEvent(e) || e.ctrlKey && !e.altKey || mac && e.metaKey) return;\r\n      var keyCode = e.keyCode, charCode = e.charCode;\r\n      if (presto && keyCode == lastStoppedKey) {lastStoppedKey = null; e_preventDefault(e); return;}\r\n      if ((presto && (!e.which || e.which < 10)) && cm.handleKeyBinding(e)) return;\r\n      var ch = String.fromCharCode(charCode == null ? keyCode : charCode);\r\n      if (cm.handleCharBinding(e, ch)) return;\r\n      cm.display.input.onKeyPress(e);\r\n    }\r\n  });\r\n\r\n});\r\n"]}