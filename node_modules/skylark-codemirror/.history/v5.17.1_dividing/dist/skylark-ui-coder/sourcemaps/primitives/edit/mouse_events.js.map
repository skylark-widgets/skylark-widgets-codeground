{"version":3,"sources":["primitives/edit/mouse_events.js"],"names":["define","CoderCtor","lastClick","lastDoubleClick","partial","onContextMenu","e","cm","this","display","eventInWidget","contextMenuInGutter","signalDOMEvent","input","hasHandler","gutterEvent","onMouseDown","activeTouch","supportsTouch","shift","shiftKey","webkit","scroller","draggable","setTimeout","clickInGutter","start","posFromMouse","window","focus","e_button","state","selectingText","leftButtonDown","e_target","e_preventDefault","lastMiddleDown","Date","extendSelection","doc","captureRightClick","delayBlurEvent","ie","bind","ensureFocus","curOp","activeElt","type","now","time","cmp","pos","contained","sel","modifier","mac","metaKey","ctrlKey","options","dragDrop","dragAndDrop","isReadOnly","contains","ranges","from","xRel","to","leftButtonStartDrag","leftButtonSelect","startTime","dragEnd","operation","e2","draggingText","off","document","Math","abs","clientX","clientY","ie_version","body","copy","altKey","on","addNew","extendTo","lastPos","tabSize","startCol","countColumn","getLine","line","text","ch","posCol","left","min","right","max","end","lastLine","leftPos","findColumn","push","Range","Pos","length","setSelection","normalizeSelection","startSel","slice","ourIndex","concat","origin","scroll","scrollIntoView","oldRange","ourRange","anchor","head","range","findWordAt","clipPos","minPos","maxPos","sel_mouse","extend","curCount","counter","cur","visible","visibleLines","outside","editorSize","top","bottom","scrollTop","done","Infinity","move","up","history","lastSelOrigin","primary","primIndex","chromeOS","word","extendRange","empty","replaceOneSelection","Selection","wrapper","getBoundingClientRect","prevent","mX","mY","floor","gutters","lineBox","lineDiv","e_defaultPrevented","viewOffset","i","g","childNodes","lineAtHeight","gutter","signal"],"mappings":"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","file":"../../../primitives/edit/mouse_events.js","sourcesContent":["define([\r\n  \"../CoderCtor\"\r\n],function(CoderCtor) {\r\n  // CONTEXT MENU HANDLING\r\n\r\n  var lastClick, lastDoubleClick;\r\n\r\n  CoderCtor.partial({\r\n    // To make the context menu work, we need to briefly unhide the\r\n    // textarea (making it as unobtrusive as possible) to let the\r\n    // right-click take effect on it.\r\n    onContextMenu : function (e) {\r\n      var cm = this;\r\n\r\n      if (cm.display.eventInWidget( e) || cm.contextMenuInGutter(e)) return;\r\n      if (cm.signalDOMEvent(e, \"contextmenu\")) return;\r\n      cm.display.input.onContextMenu(e);\r\n    },\r\n\r\n    contextMenuInGutter : function (e) {\r\n      var cm = this;\r\n\r\n      if (!cm.hasHandler(\"gutterContextMenu\")) return false;\r\n      return cm.gutterEvent(e, \"gutterContextMenu\", false);\r\n    },\r\n\r\n   // MOUSE EVENTS\r\n   \r\n    // A mouse down can be a single click, double click, triple click,\r\n    // start of selection drag, start of text drag, new cursor\r\n    // (ctrl-click), rectangle drag (alt-drag), or xwin\r\n    // middle-click-paste. Or it might be a click on something we should\r\n    // not interfere with, such as a scrollbar or widget.\r\n    onMouseDown : function (e) {\r\n      var cm = this, display = cm.display;\r\n      if (cm.signalDOMEvent(e) || display.activeTouch && display.input.supportsTouch()) return;\r\n      display.shift = e.shiftKey;\r\n\r\n      if (display.eventInWidget(e)) {\r\n        if (!webkit) {\r\n          // Briefly turn off draggability, to allow widgets to do\r\n          // normal dragging things.\r\n          display.scroller.draggable = false;\r\n          setTimeout(function(){display.scroller.draggable = true;}, 100);\r\n        }\r\n        return;\r\n      }\r\n      if (cm.clickInGutter(e)) return;\r\n      var start = cm.posFromMouse(e);\r\n      window.focus();\r\n\r\n      switch (e_button(e)) {\r\n      case 1:\r\n        // #3261: make sure, that we're not starting a second selection\r\n        if (cm.state.selectingText)\r\n          cm.state.selectingText(e);\r\n        else if (start)\r\n          cm.leftButtonDown(e, start);\r\n        else if (e_target(e) == display.scroller)\r\n          e_preventDefault(e);\r\n        break;\r\n      case 2:\r\n        if (webkit) cm.state.lastMiddleDown = +new Date;\r\n        if (start) extendSelection(cm.doc, start);\r\n        setTimeout(function() {display.input.focus();}, 20);\r\n        e_preventDefault(e);\r\n        break;\r\n      case 3:\r\n        if (captureRightClick) cm.onContextMenu(e);\r\n        else cm.delayBlurEvent(cm);\r\n        break;\r\n      }\r\n    },\r\n\r\n    leftButtonDown : function (e, start) {\r\n      var cm = this;\r\n\r\n      if (ie) setTimeout(bind(ensureFocus, cm), 0);\r\n      else cm.curOp.focus = activeElt();\r\n\r\n      var now = +new Date, type;\r\n      if (lastDoubleClick && lastDoubleClick.time > now - 400 && cmp(lastDoubleClick.pos, start) == 0) {\r\n        type = \"triple\";\r\n      } else if (lastClick && lastClick.time > now - 400 && cmp(lastClick.pos, start) == 0) {\r\n        type = \"double\";\r\n        lastDoubleClick = {time: now, pos: start};\r\n      } else {\r\n        type = \"single\";\r\n        lastClick = {time: now, pos: start};\r\n      }\r\n\r\n      var sel = cm.doc.sel, modifier = mac ? e.metaKey : e.ctrlKey, contained;\r\n      if (cm.options.dragDrop && dragAndDrop && !cm.isReadOnly() &&\r\n          type == \"single\" && (contained = sel.contains(start)) > -1 &&\r\n          (cmp((contained = sel.ranges[contained]).from(), start) < 0 || start.xRel > 0) &&\r\n          (cmp(contained.to(), start) > 0 || start.xRel < 0))\r\n        cm.leftButtonStartDrag(e, start, modifier);\r\n      else\r\n        cm.leftButtonSelect(e, start, type, modifier);\r\n    },\r\n\r\n    // Start a text drag. When it ends, see if any dragging actually\r\n    // happen, and treat as a click if it didn't.\r\n    leftButtonStartDrag : function (e, start, modifier) {\r\n      var cm = this;\r\n\r\n      var display = cm.display, startTime = +new Date;\r\n      var dragEnd = cm.operation(function(e2) {\r\n        if (webkit) display.scroller.draggable = false;\r\n        cm.state.draggingText = false;\r\n        off(document, \"mouseup\", dragEnd);\r\n        off(display.scroller, \"drop\", dragEnd);\r\n        if (Math.abs(e.clientX - e2.clientX) + Math.abs(e.clientY - e2.clientY) < 10) {\r\n          e_preventDefault(e2);\r\n          if (!modifier && +new Date - 200 < startTime)\r\n            cm.extendSelection(cm.doc, start);\r\n          // Work around unexplainable focus problem in IE9 (#2127) and Chrome (#3081)\r\n          if (webkit || ie && ie_version == 9)\r\n            setTimeout(function() {document.body.focus(); display.input.focus();}, 20);\r\n          else\r\n            display.input.focus();\r\n        }\r\n      });\r\n      // Let the drag handler handle this.\r\n      if (webkit) display.scroller.draggable = true;\r\n      cm.state.draggingText = dragEnd;\r\n      dragEnd.copy = mac ? e.altKey : e.ctrlKey\r\n      // IE's approach to draggable\r\n      if (display.scroller.dragDrop) display.scroller.dragDrop();\r\n      on(document, \"mouseup\", dragEnd);\r\n      on(display.scroller, \"drop\", dragEnd);\r\n    },\r\n\r\n    // Normal selection, as opposed to text dragging.\r\n    leftButtonSelect : function (e, start, type, addNew) {\r\n      var cm = this;\r\n\r\n      var display = cm.display, doc = cm.doc;\r\n      e_preventDefault(e);\r\n\r\n      var ourRange, ourIndex, startSel = doc.sel, ranges = startSel.ranges;\r\n      if (addNew && !e.shiftKey) {\r\n        ourIndex = doc.sel.contains(start);\r\n        if (ourIndex > -1)\r\n          ourRange = ranges[ourIndex];\r\n        else\r\n          ourRange = new Range(start, start);\r\n      } else {\r\n        ourRange = doc.sel.primary();\r\n        ourIndex = doc.sel.primIndex;\r\n      }\r\n\r\n      if (chromeOS ? e.shiftKey && e.metaKey : e.altKey) {\r\n        type = \"rect\";\r\n        if (!addNew) ourRange = new Range(start, start);\r\n        start = cm.posFromMouse(e, true, true);\r\n        ourIndex = -1;\r\n      } else if (type == \"double\") {\r\n        var word = cm.findWordAt(start);\r\n        if (cm.display.shift || doc.extend)\r\n          ourRange = extendRange(doc, ourRange, word.anchor, word.head);\r\n        else\r\n          ourRange = word;\r\n      } else if (type == \"triple\") {\r\n        var line = new Range(Pos(start.line, 0), clipPos(doc, Pos(start.line + 1, 0)));\r\n        if (cm.display.shift || doc.extend)\r\n          ourRange = extendRange(doc, ourRange, line.anchor, line.head);\r\n        else\r\n          ourRange = line;\r\n      } else {\r\n        ourRange = extendRange(doc, ourRange, start);\r\n      }\r\n\r\n      if (!addNew) {\r\n        ourIndex = 0;\r\n        setSelection(doc, new Selection([ourRange], 0), sel_mouse);\r\n        startSel = doc.sel;\r\n      } else if (ourIndex == -1) {\r\n        ourIndex = ranges.length;\r\n        setSelection(doc, normalizeSelection(ranges.concat([ourRange]), ourIndex),\r\n                     {scroll: false, origin: \"*mouse\"});\r\n      } else if (ranges.length > 1 && ranges[ourIndex].empty() && type == \"single\" && !e.shiftKey) {\r\n        setSelection(doc, normalizeSelection(ranges.slice(0, ourIndex).concat(ranges.slice(ourIndex + 1)), 0),\r\n                     {scroll: false, origin: \"*mouse\"});\r\n        startSel = doc.sel;\r\n      } else {\r\n        replaceOneSelection(doc, ourIndex, ourRange, sel_mouse);\r\n      }\r\n\r\n      var lastPos = start;\r\n      function extendTo(pos) {\r\n        if (cmp(lastPos, pos) == 0) return;\r\n        lastPos = pos;\r\n\r\n        if (type == \"rect\") {\r\n          var ranges = [], tabSize = cm.options.tabSize;\r\n          var startCol = countColumn(getLine(doc, start.line).text, start.ch, tabSize);\r\n          var posCol = countColumn(getLine(doc, pos.line).text, pos.ch, tabSize);\r\n          var left = Math.min(startCol, posCol), right = Math.max(startCol, posCol);\r\n          for (var line = Math.min(start.line, pos.line), end = Math.min(cm.lastLine(), Math.max(start.line, pos.line));\r\n               line <= end; line++) {\r\n            var text = getLine(doc, line).text, leftPos = findColumn(text, left, tabSize);\r\n            if (left == right)\r\n              ranges.push(new Range(Pos(line, leftPos), Pos(line, leftPos)));\r\n            else if (text.length > leftPos)\r\n              ranges.push(new Range(Pos(line, leftPos), Pos(line, findColumn(text, right, tabSize))));\r\n          }\r\n          if (!ranges.length) ranges.push(new Range(start, start));\r\n          setSelection(doc, normalizeSelection(startSel.ranges.slice(0, ourIndex).concat(ranges), ourIndex),\r\n                       {origin: \"*mouse\", scroll: false});\r\n          cm.scrollIntoView(pos);\r\n        } else {\r\n          var oldRange = ourRange;\r\n          var anchor = oldRange.anchor, head = pos;\r\n          if (type != \"single\") {\r\n            if (type == \"double\")\r\n              var range = cm.findWordAt(pos);\r\n            else\r\n              var range = new Range(Pos(pos.line, 0), clipPos(doc, Pos(pos.line + 1, 0)));\r\n            if (cmp(range.anchor, anchor) > 0) {\r\n              head = range.head;\r\n              anchor = minPos(oldRange.from(), range.anchor);\r\n            } else {\r\n              head = range.anchor;\r\n              anchor = maxPos(oldRange.to(), range.head);\r\n            }\r\n          }\r\n          var ranges = startSel.ranges.slice(0);\r\n          ranges[ourIndex] = new Range(clipPos(doc, anchor), head);\r\n          setSelection(doc, normalizeSelection(ranges, ourIndex), sel_mouse);\r\n        }\r\n      }\r\n\r\n      var editorSize = display.wrapper.getBoundingClientRect();\r\n      // Used to ensure timeout re-tries don't fire when another extend\r\n      // happened in the meantime (clearTimeout isn't reliable -- at\r\n      // least on Chrome, the timeouts still happen even when cleared,\r\n      // if the clear happens after their scheduled firing time).\r\n      var counter = 0;\r\n\r\n      function extend(e) {\r\n        var curCount = ++counter;\r\n        var cur = cm.posFromMouse(e, true, type == \"rect\");\r\n        if (!cur) return;\r\n        if (cmp(cur, lastPos) != 0) {\r\n          cm.curOp.focus = activeElt();\r\n          extendTo(cur);\r\n          var visible = visibleLines(display, doc);\r\n          if (cur.line >= visible.to || cur.line < visible.from)\r\n            setTimeout(cm.operation(function(){if (counter == curCount) extend(e);}), 150);\r\n        } else {\r\n          var outside = e.clientY < editorSize.top ? -20 : e.clientY > editorSize.bottom ? 20 : 0;\r\n          if (outside) setTimeout(cm.operation(function() {\r\n            if (counter != curCount) return;\r\n            display.scroller.scrollTop += outside;\r\n            extend(e);\r\n          }), 50);\r\n        }\r\n      }\r\n\r\n      function done(e) {\r\n        cm.state.selectingText = false;\r\n        counter = Infinity;\r\n        e_preventDefault(e);\r\n        display.input.focus();\r\n        off(document, \"mousemove\", move);\r\n        off(document, \"mouseup\", up);\r\n        doc.history.lastSelOrigin = null;\r\n      }\r\n\r\n      var move = cm.operation(function(e) {\r\n        if (!e_button(e)) done(e);\r\n        else extend(e);\r\n      });\r\n      var up = cm.operation(done);\r\n      cm.state.selectingText = up;\r\n      on(document, \"mousemove\", move);\r\n      on(document, \"mouseup\", up);\r\n    },\r\n\r\n    // Determines whether an event happened in the gutter, and fires the\r\n    // handlers for the corresponding event.\r\n    gutterEvent : function (e, type, prevent) {\r\n      var cm = this;\r\n\r\n      try { var mX = e.clientX, mY = e.clientY; }\r\n      catch(e) { return false; }\r\n      if (mX >= Math.floor(cm.display.gutters.getBoundingClientRect().right)) return false;\r\n      if (prevent) e_preventDefault(e);\r\n\r\n      var display = cm.display;\r\n      var lineBox = display.lineDiv.getBoundingClientRect();\r\n\r\n      if (mY > lineBox.bottom || !hasHandler(type)) return e_defaultPrevented(e);\r\n      mY -= lineBox.top - display.viewOffset;\r\n\r\n      for (var i = 0; i < cm.options.gutters.length; ++i) {\r\n        var g = display.gutters.childNodes[i];\r\n        if (g && g.getBoundingClientRect().right >= mX) {\r\n          var line = lineAtHeight(cm.doc, mY);\r\n          var gutter = cm.options.gutters[i];\r\n          cm.signal(type, cm, line, gutter, e);\r\n          return e_defaultPrevented(e);\r\n        }\r\n      }\r\n    },\r\n\r\n    clickInGutter : function (e) {\r\n      var cm = this;\r\n\r\n      return cm.gutterEvent(e, \"gutterClick\", true);\r\n    }\r\n  });\r\n  \r\n});\r\n"]}