/**
 * skylark-codemirror - A version of codemirror 5.45  that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-codemirror/
 * @license MIT
 */
define(["../edit/CodeMirror","../display/operations","../line/line_data","../line/pos","../line/spans","../line/utils_line","../util/dom","../util/feature_detection","../util/misc","../display/scrolling","./changes","./change_measurement","./chunk","./document_data","./history","./line_widget","./mark_text","./selection","./selection_updates"],function(t,e,i,n,s,r,o,l,h,c,u,a,d,f,p,g,m,y,k){"use strict";let S=0,M=function(t,e,s,r,o){if(!(this instanceof M))return new M(t,e,s,r,o);null==s&&(s=0),d.BranchChunk.call(this,[new d.LeafChunk([new i.Line("",null)])]),this.first=s,this.scrollTop=this.scrollLeft=0,this.cantEdit=!1,this.cleanGeneration=1,this.modeFrontier=this.highlightFrontier=s;let l=n.Pos(s,0);this.sel=y.simpleSelection(l),this.history=new p.History(null),this.id=++S,this.modeOption=e,this.lineSep=r,this.direction="rtl"==o?"rtl":"ltr",this.extend=!1,"string"==typeof t&&(t=this.splitLines(t)),f.updateDoc(this,{from:l,to:l,text:t}),k.setSelection(this,y.simpleSelection(l),h.sel_dontScroll)};return M.prototype=h.createObj(d.BranchChunk.prototype,{constructor:M,iter:function(t,e,i){i?this.iterN(t-this.first,e-t,i):this.iterN(this.first,this.first+this.size,t)},insert:function(t,e){let i=0;for(let t=0;t<e.length;++t)i+=e[t].height;this.insertInner(t-this.first,e,i)},remove:function(t,e){this.removeInner(t-this.first,e)},getValue:function(t){let e=r.getLines(this,this.first,this.first+this.size);return!1===t?e:e.join(t||this.lineSeparator())},setValue:e.docMethodOp(function(t){let e=n.Pos(this.first,0),i=this.first+this.size-1;u.makeChange(this,{from:e,to:n.Pos(i,r.getLine(this,i).text.length),text:this.splitLines(t),origin:"setValue",full:!0},!0),this.cm&&c.scrollToCoords(this.cm,0,0),k.setSelection(this,y.simpleSelection(e),h.sel_dontScroll)}),replaceRange:function(t,e,i,s){e=n.clipPos(this,e),i=i?n.clipPos(this,i):e,u.replaceRange(this,t,e,i,s)},getRange:function(t,e,i){let s=r.getBetween(this,n.clipPos(this,t),n.clipPos(this,e));return!1===i?s:s.join(i||this.lineSeparator())},getLine:function(t){let e=this.getLineHandle(t);return e&&e.text},getLineHandle:function(t){if(r.isLine(this,t))return r.getLine(this,t)},getLineNumber:function(t){return r.lineNo(t)},getLineHandleVisualStart:function(t){return"number"==typeof t&&(t=r.getLine(this,t)),s.visualLine(t)},lineCount:function(){return this.size},firstLine:function(){return this.first},lastLine:function(){return this.first+this.size-1},clipPos:function(t){return n.clipPos(this,t)},getCursor:function(t){let e,i=this.sel.primary();return e=null==t||"head"==t?i.head:"anchor"==t?i.anchor:"end"==t||"to"==t||!1===t?i.to():i.from()},listSelections:function(){return this.sel.ranges},somethingSelected:function(){return this.sel.somethingSelected()},setCursor:e.docMethodOp(function(t,e,i){k.setSimpleSelection(this,n.clipPos(this,"number"==typeof t?n.Pos(t,e||0):t),null,i)}),setSelection:e.docMethodOp(function(t,e,i){k.setSimpleSelection(this,n.clipPos(this,t),n.clipPos(this,e||t),i)}),extendSelection:e.docMethodOp(function(t,e,i){k.extendSelection(this,n.clipPos(this,t),e&&n.clipPos(this,e),i)}),extendSelections:e.docMethodOp(function(t,e){k.extendSelections(this,n.clipPosArray(this,t),e)}),extendSelectionsBy:e.docMethodOp(function(t,e){let i=h.map(this.sel.ranges,t);k.extendSelections(this,n.clipPosArray(this,i),e)}),setSelections:e.docMethodOp(function(t,e,i){if(!t.length)return;let s=[];for(let e=0;e<t.length;e++)s[e]=new y.Range(n.clipPos(this,t[e].anchor),n.clipPos(this,t[e].head));null==e&&(e=Math.min(t.length-1,this.sel.primIndex)),k.setSelection(this,y.normalizeSelection(this.cm,s,e),i)}),addSelection:e.docMethodOp(function(t,e,i){let s=this.sel.ranges.slice(0);s.push(new y.Range(n.clipPos(this,t),n.clipPos(this,e||t))),k.setSelection(this,y.normalizeSelection(this.cm,s,s.length-1),i)}),getSelection:function(t){let e,i=this.sel.ranges;for(let t=0;t<i.length;t++){let n=r.getBetween(this,i[t].from(),i[t].to());e=e?e.concat(n):n}return!1===t?e:e.join(t||this.lineSeparator())},getSelections:function(t){let e=[],i=this.sel.ranges;for(let n=0;n<i.length;n++){let s=r.getBetween(this,i[n].from(),i[n].to());!1!==t&&(s=s.join(t||this.lineSeparator())),e[n]=s}return e},replaceSelection:function(t,e,i){let n=[];for(let e=0;e<this.sel.ranges.length;e++)n[e]=t;this.replaceSelections(n,e,i||"+input")},replaceSelections:e.docMethodOp(function(t,e,i){let n=[],s=this.sel;for(let e=0;e<s.ranges.length;e++){let r=s.ranges[e];n[e]={from:r.from(),to:r.to(),text:this.splitLines(t[e]),origin:i}}let r=e&&"end"!=e&&a.computeReplacedSel(this,n,e);for(let t=n.length-1;t>=0;t--)u.makeChange(this,n[t]);r?k.setSelectionReplaceHistory(this,r):this.cm&&c.ensureCursorVisible(this.cm)}),undo:e.docMethodOp(function(){u.makeChangeFromHistory(this,"undo")}),redo:e.docMethodOp(function(){u.makeChangeFromHistory(this,"redo")}),undoSelection:e.docMethodOp(function(){u.makeChangeFromHistory(this,"undo",!0)}),redoSelection:e.docMethodOp(function(){u.makeChangeFromHistory(this,"redo",!0)}),setExtending:function(t){this.extend=t},getExtending:function(){return this.extend},historySize:function(){let t=this.history,e=0,i=0;for(let i=0;i<t.done.length;i++)t.done[i].ranges||++e;for(let e=0;e<t.undone.length;e++)t.undone[e].ranges||++i;return{undo:e,redo:i}},clearHistory:function(){this.history=new p.History(this.history.maxGeneration)},markClean:function(){this.cleanGeneration=this.changeGeneration(!0)},changeGeneration:function(t){return t&&(this.history.lastOp=this.history.lastSelOp=this.history.lastOrigin=null),this.history.generation},isClean:function(t){return this.history.generation==(t||this.cleanGeneration)},getHistory:function(){return{done:p.copyHistoryArray(this.history.done),undone:p.copyHistoryArray(this.history.undone)}},setHistory:function(t){let e=this.history=new p.History(this.history.maxGeneration);e.done=p.copyHistoryArray(t.done.slice(0),null,!0),e.undone=p.copyHistoryArray(t.undone.slice(0),null,!0)},setGutterMarker:e.docMethodOp(function(t,e,i){return u.changeLine(this,t,"gutter",t=>{let n=t.gutterMarkers||(t.gutterMarkers={});return n[e]=i,!i&&h.isEmpty(n)&&(t.gutterMarkers=null),!0})}),clearGutter:e.docMethodOp(function(t){this.iter(e=>{e.gutterMarkers&&e.gutterMarkers[t]&&u.changeLine(this,e,"gutter",()=>(e.gutterMarkers[t]=null,h.isEmpty(e.gutterMarkers)&&(e.gutterMarkers=null),!0))})}),lineInfo:function(t){let e;if("number"==typeof t){if(!r.isLine(this,t))return null;if(e=t,!(t=r.getLine(this,t)))return null}else if(null==(e=r.lineNo(t)))return null;return{line:e,handle:t,text:t.text,gutterMarkers:t.gutterMarkers,textClass:t.textClass,bgClass:t.bgClass,wrapClass:t.wrapClass,widgets:t.widgets}},addLineClass:e.docMethodOp(function(t,e,i){return u.changeLine(this,t,"gutter"==e?"gutter":"class",t=>{let n="text"==e?"textClass":"background"==e?"bgClass":"gutter"==e?"gutterClass":"wrapClass";if(t[n]){if(o.classTest(i).test(t[n]))return!1;t[n]+=" "+i}else t[n]=i;return!0})}),removeLineClass:e.docMethodOp(function(t,e,i){return u.changeLine(this,t,"gutter"==e?"gutter":"class",t=>{let n="text"==e?"textClass":"background"==e?"bgClass":"gutter"==e?"gutterClass":"wrapClass",s=t[n];if(!s)return!1;if(null==i)t[n]=null;else{let e=s.match(o.classTest(i));if(!e)return!1;let r=e.index+e[0].length;t[n]=s.slice(0,e.index)+(e.index&&r!=s.length?" ":"")+s.slice(r)||null}return!0})}),addLineWidget:e.docMethodOp(function(t,e,i){return g.addLineWidget(this,t,e,i)}),removeLineWidget:function(t){t.clear()},markText:function(t,e,i){return m.markText(this,n.clipPos(this,t),n.clipPos(this,e),i,i&&i.type||"range")},setBookmark:function(t,e){let i={replacedWith:e&&(null==e.nodeType?e.widget:e),insertLeft:e&&e.insertLeft,clearWhenEmpty:!1,shared:e&&e.shared,handleMouseEvents:e&&e.handleMouseEvents};return t=n.clipPos(this,t),m.markText(this,t,t,i,"bookmark")},findMarksAt:function(t){t=n.clipPos(this,t);let e=[],i=r.getLine(this,t.line).markedSpans;if(i)for(let n=0;n<i.length;++n){let s=i[n];(null==s.from||s.from<=t.ch)&&(null==s.to||s.to>=t.ch)&&e.push(s.marker.parent||s.marker)}return e},findMarks:function(t,e,i){t=n.clipPos(this,t),e=n.clipPos(this,e);let s=[],r=t.line;return this.iter(t.line,e.line+1,n=>{let o=n.markedSpans;if(o)for(let n=0;n<o.length;n++){let l=o[n];null!=l.to&&r==t.line&&t.ch>=l.to||null==l.from&&r!=t.line||null!=l.from&&r==e.line&&l.from>=e.ch||i&&!i(l.marker)||s.push(l.marker.parent||l.marker)}++r}),s},getAllMarks:function(){let t=[];return this.iter(e=>{let i=e.markedSpans;if(i)for(let e=0;e<i.length;++e)null!=i[e].from&&t.push(i[e].marker)}),t},posFromIndex:function(t){let e,i=this.first,s=this.lineSeparator().length;return this.iter(n=>{let r=n.text.length+s;if(r>t)return e=t,!0;t-=r,++i}),n.clipPos(this,n.Pos(i,e))},indexFromPos:function(t){let e=(t=n.clipPos(this,t)).ch;if(t.line<this.first||t.ch<0)return 0;let i=this.lineSeparator().length;return this.iter(this.first,t.line,t=>{e+=t.text.length+i}),e},copy:function(t){let e=new M(r.getLines(this,this.first,this.first+this.size),this.modeOption,this.first,this.lineSep,this.direction);return e.scrollTop=this.scrollTop,e.scrollLeft=this.scrollLeft,e.sel=this.sel,e.extend=!1,t&&(e.history.undoDepth=this.history.undoDepth,e.setHistory(this.getHistory())),e},linkedDoc:function(t){t||(t={});let e=this.first,i=this.first+this.size;null!=t.from&&t.from>e&&(e=t.from),null!=t.to&&t.to<i&&(i=t.to);let n=new M(r.getLines(this,e,i),t.mode||this.modeOption,e,this.lineSep,this.direction);return t.sharedHist&&(n.history=this.history),(this.linked||(this.linked=[])).push({doc:n,sharedHist:t.sharedHist}),n.linked=[{doc:this,isParent:!0,sharedHist:t.sharedHist}],m.copySharedMarkers(n,m.findSharedMarkers(this)),n},unlinkDoc:function(e){if(e instanceof t&&(e=e.doc),this.linked)for(let t=0;t<this.linked.length;++t){if(this.linked[t].doc==e){this.linked.splice(t,1),e.unlinkDoc(this),m.detachSharedMarkers(m.findSharedMarkers(this));break}}if(e.history==this.history){let t=[e.id];f.linkedDocs(e,e=>t.push(e.id),!0),e.history=new p.History(null),e.history.done=p.copyHistoryArray(this.history.done,t),e.history.undone=p.copyHistoryArray(this.history.undone,t)}},iterLinkedDocs:function(t){f.linkedDocs(this,t)},getMode:function(){return this.mode},getEditor:function(){return this.cm},splitLines:function(t){return this.lineSep?t.split(this.lineSep):l.splitLinesAuto(t)},lineSeparator:function(){return this.lineSep||"\n"},setDirection:e.docMethodOp(function(t){"rtl"!=t&&(t="ltr"),t!=this.direction&&(this.direction=t,this.iter(t=>t.order=null),this.cm&&f.directionChanged(this.cm))})}),M.prototype.eachLine=M.prototype.iter,M});
//# sourceMappingURL=../../sourcemaps/primitives/model/Doc.js.map
